<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Touch Yellow - World 2</title>
    <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Roboto:wght@900&display=swap" rel="stylesheet">
    <style>
        /* --- SHARED CORE (Matches index.html) --- */
        body { margin:0; background:#000; overflow:hidden; font-family:'Roboto',sans-serif; height:100vh; display:flex; justify-content:center; align-items:center; user-select:none; touch-action:none; }
        #game { width:100%; max-width:177.7vh; aspect-ratio:16/9; position:relative; background:#000; box-shadow:0 0 50px #00b0f0; } /* Blue Shadow for World 2 */
        .layer { position:absolute; inset:0; pointer-events:none; }
        #ui { z-index:500; pointer-events:auto; }

        /* --- WORLD 2 MENU (Blue Screen) --- */
        #menu-screen { position:absolute; top:0; left:0; width:100%; height:100%; background-color:#2cb5e9; display:flex; flex-direction:column; align-items:center; justify-content:center; pointer-events:auto; cursor:default; }
        .save-title { font-family:'Roboto',sans-serif; font-weight:900; font-size:10vh; color:#000; margin-bottom:5vh; text-align:center; }
        
        .menu-btn-row { display:flex; align-items:center; gap:2vh; margin-bottom:3vh; cursor:pointer; transition:transform 0.1s; }
        .menu-btn-row:active { transform:scale(0.95); }
        .btn-circle { width:8vh; height:8vh; background-color:#f2a922; border:0.4vh solid #bf8310; border-radius:50%; box-shadow:0 0.5vh 0 rgba(0,0,0,0.2); }
        .btn-text { font-family:'Roboto',sans-serif; font-weight:900; font-size:5vh; color:#000; }

        /* --- GAME ELEMENTS --- */
        .obj { position:absolute; box-shadow: 0 0 0 1px currentColor; }
        .path { background:#26a9e1; color:#26a9e1; } .goal { background:#f1a92a; color:#f1a92a; } 
        .obs { background:#000; color:transparent; } 
        .btn { background:#33cc33; color:#33cc33; } .btn.on { background:#228822; color:#228822; }
        .paused { animation-play-state: paused !important; }

        /* --- DEBUG VISUALS --- */
        .hitbox { position:absolute; z-index:400; opacity:0; }
        .debug .hitbox { opacity:1 !important; }
        .debug .hitbox.path { background:transparent; border:none; }
        .debug .hitbox.goal { background:rgba(241,169,42,0.5); border:2px solid yellow; }
        .debug .hitbox.obs { background:rgba(255,0,0,0.6); border:2px solid red; }
        .debug .hitbox.trig, .debug .hitbox.btn { background:rgba(148,0,211,0.5); border:2px dashed magenta; }
        .debug .hitbox.start { background:rgba(0,255,0,0.2); border:1px dotted lime; }

        /* DEBUG LINES */
        .debug-line { position:fixed; background-color:cyan; pointer-events:none; z-index:9999; display:none; }
        .debug .debug-line { display:block; }
        #debug-cross-x { width:100%; height:1px; left:0; }
        #debug-cross-y { width:1px; height:100%; top:0; }
        #db-coords { position:absolute; bottom:5px; right:5px; color:cyan; font-family:monospace; font-size:2vh; font-weight:bold; background:rgba(0,0,0,0.8); padding:2px 5px; border:1px solid cyan; }
        #db-room { position:absolute; bottom:5px; left:5px; color:cyan; font-family:monospace; font-size:2vh; font-weight:bold; background:rgba(0,0,0,0.8); padding:2px 5px; border:1px solid cyan; }

        /* INDICATORS */
        #cheat-ind { position:absolute; bottom:10px; left:10px; color:yellow; font-weight:bold; display:none; z-index:999; font-family:monospace; font-size:2vh; }
        #debug-ind { position:absolute; bottom:35px; left:10px; color:lime; font-weight:bold; display:none; z-index:999; font-family:monospace; font-size:2vh; }
        
        /* ANIMATIONS */
        @keyframes crazyMove { 0% { transform: translate(0, 0); } 20% { transform: translate(250%, -350%); } 40% { transform: translate(250%, 0%); } 60% { transform: translate(120%, -150%); } 80% { transform: translate(0, -350%); } 100% { transform: translate(0, 0); } }
    </style>
</head>
<body oncontextmenu="return false;">
    
    <div id="game">
        <!-- Debug Tools -->
        <div class="debug-overlay">
            <div id="db-cross-x" class="debug-line"></div>
            <div id="db-cross-y" class="debug-line"></div>
            <div id="db-coords">X: 0.00% Y: 0.00%</div>
            <div id="db-room">ROOM: MENU</div>
        </div>

        <div id="gfx" class="layer" style="z-index:10"></div>
        <div id="phy" class="layer"></div>
        <div id="ui" class="layer">
            
            <!-- WORLD 2 MENU -->
            <div id="menu-screen">
                <div class="save-title">Got Save!</div>
                <div class="menu-btn-row" onclick="Engine.start(6)"><div class="btn-circle"></div><div class="btn-text">&lt;-Continue</div></div>
                <div class="menu-btn-row" onclick="location.href='../index.html'"><div class="btn-circle"></div><div class="btn-text">&lt;-Menu</div></div>
                <div class="menu-btn-row" onclick="alert('Use Browser Close')"><div class="btn-circle"></div><div class="btn-text">&lt;-Exit</div></div>
            </div>

            <div id="cheat-ind">NOCLIP ON</div>
            <div id="debug-ind">HITBOXES ON</div>
        </div>
    </div>

<script>
// --- SECURITY: PREVENT UNAUTHORIZED ACCESS ---
if (localStorage.getItem('touchYellow_save1') !== 'true') {
    document.body.innerHTML = ""; document.body.style.background = "#000";
    alert("Save File Locked! Completing Level 5 is required.");
    window.location.href = "../index.html";
    throw new Error("Redirecting...");
}

const LevelData = {
    // THE Z-SHAPE TRAP
    6: (d) => {
        const H = 14; const W = 7.875;
        
        // 1. Z-SHAPE GEOMETRY (Top-Left is Void)
        d.path(50, 0, 50, 50);   // Top Right Area
        d.path(0, 50, 100, 50);  // Bottom Floor
        d.path(0, 5, 55, 5);     // Thin Safety Bridge crossing the void
        
        // 2. START ZONE (Save1 always uses Ghost Mode)
        d.start(0, 0, 15, 15);
        
        // 3. THE TRAP GOAL
        const g = d.goal(10, 65, W, H, 7);
        g.vis.style.animation = "crazyMove 3s linear infinite"; 
        g.hit.style.animation = "crazyMove 3s linear infinite";
        
        // Pause it so it sits still at first
        g.vis.classList.add('paused'); 
        g.hit.classList.add('paused'); 
        g.tag = "runner";

        // 4. INVISIBLE TRIGGER (Vertical Line)
        const t = d.trig(35, 50, 2, 50); 
        t.link = "runner";
    },
    
    // FILLER LEVEL
    7: (d) => { 
        d.start(10, 20, 10, 15);
        d.path(10, 20, 10, 60); d.path(10, 80, 80, 14); d.goal(80, 20, 8, 14, 'win'); 
    }
};

const Engine = {
    active: false, state: 'menu', mx:0, my:0, mobile:false, holding:false, hitboxes:[], noclip: false,
    els: { gfx:document.getElementById('gfx'), phy:document.getElementById('phy'), ui:document.getElementById('ui') },
    
    init() {
        this.mobile = 'ontouchstart' in window;
        const move = (x,y) => { 
            this.mx=x; this.my=y;
            // Debug Updates
            const cx=document.getElementById('db-cross-x'); const cy=document.getElementById('db-cross-y'); const ct=document.getElementById('db-coords');
            if(cx&&cy){
                const r=document.getElementById('game').getBoundingClientRect();
                const ly=y-r.top; const lx=x-r.left;
                cx.style.top=ly+'px'; cy.style.left=lx+'px';
                if(ct){ const px=(lx/r.width*100).toFixed(2); const py=(ly/r.height*100).toFixed(2); ct.innerText=`X: ${px}% Y: ${py}%`; }
            }
        };
        window.addEventListener('mousemove', e => move(e.clientX, e.clientY));
        window.addEventListener('touchmove', e => { e.preventDefault(); move(e.touches[0].clientX, e.touches[0].clientY); }, {passive:false});
        
        const down = () => this.holding=true;
        const up = () => { this.holding=false; if(this.state==='playing' && this.mobile) this.die(); };
        window.addEventListener('mousedown', down); window.addEventListener('touchstart', down);
        window.addEventListener('mouseup', up); window.addEventListener('touchend', up);
        
        // Right Click Death
        window.addEventListener('mousedown', e => { if(e.button===2 && this.active && !this.noclip) this.die(); });
        
        this.loop();
    },

    start(id) {
        if (!document.fullscreenElement) { document.documentElement.requestFullscreen().catch(e=>{}); }
        this.active = true; 
        
        // SAVE FILES ALWAYS START IN WAITING/GHOST MODE
        this.state = 'waiting'; 
        
        document.getElementById('menu-screen').style.display='none';
        this.hitboxes=[]; this.els.gfx.innerHTML=''; this.els.phy.innerHTML='';
        
        document.getElementById('db-room').innerText = "ROOM: LEVEL " + id;
        
        const builder = {
            path: (x,y,w,h) => this.spawn(x,y,w,h,'path'),
            obs: (x,y,w,h,a) => this.spawn(x,y,w,h,'obs',a),
            goal: (x,y,w,h,n) => this.spawn(x,y,w,h,'goal',n),
            start: (x,y,w,h) => this.spawn(x,y,w,h,'start'),
            btn: (x,y,w,h) => this.spawn(x,y,w,h,'btn'),
            trig: (x,y,w,h) => this.spawn(x,y,w,h,'trig')
        };

        if(LevelData[id]) LevelData[id](builder); 
        else { alert("World 2 Complete!"); location.href='../index.html'; }
    },

    spawn(x,y,w,h,type,anim,next) {
        const s = {left:x+'%', top:y+'%', width:w+'%', height:h+'%'};
        const v = document.createElement('div'); v.className=`obj ${type}`; Object.assign(v.style, s);
        if(anim) v.style.animation = anim;
        this.els.gfx.appendChild(v);
        
        const p = document.createElement('div'); p.className=`hitbox ${type}`; Object.assign(p.style, s);
        if(anim) p.style.animation = anim;
        this.els.phy.appendChild(p);

        const obj = { vis:v, hit:p, type, next, tag:"", link:"" };
        this.hitboxes.push(obj); return obj;
    },

    loop() {
        requestAnimationFrame(()=>this.loop());
        if(!this.active) return;
        const r = document.getElementById('game').getBoundingClientRect();
        const mx = (this.mx - r.left)/r.width*100;
        const my = (this.my - r.top)/r.height*100;
        
        if((mx<0||mx>100||my<0||my>100) && this.state==='playing') return this.die();
        if(this.mobile && !this.holding) return;
        
        let safe = false;
        for(let hb of this.hitboxes) {
            const hr = hb.hit.getBoundingClientRect();
            const bx=(hr.left-r.left)/r.width*100, by=(hr.top-r.top)/r.height*100;
            const bw=hr.width/r.width*100, bh=hr.height/r.height*100;

            if(mx>bx && mx<bx+bw && my>by && my<by+bh) {
                if(hb.type === 'obs' && this.state==='playing') return this.die();
                
                if(hb.type === 'path') safe = true;
                
                // Ghost Mode Logic
                if(hb.type === 'start') { 
                    safe = true; 
                    if(this.state === 'waiting') { 
                        this.state = 'playing'; 
                        console.log("Game Active");
                    } 
                }
                
                if(hb.type === 'goal') { safe=true; this.start(hb.next); }
                
                if((hb.type==='btn' || hb.type==='trig') && hb.link) {
                    safe=true;
                    this.hitboxes.forEach(t => { if(t.tag === hb.link) { t.vis.classList.remove('paused'); t.hit.classList.remove('paused'); }});
                    if(hb.type==='btn') hb.vis.classList.add('on');
                }
            }
        }
        
        document.getElementById('game').style.cursor = (this.state==='playing' && safe) ? 'crosshair' : 'default';
        if(this.state==='playing' && !safe) this.die();
    },

    die() { if(this.noclip) return; this.active = false; this.start(6); },
    reset() { this.active=false; this.hitboxes=[]; this.els.gfx.innerHTML=''; this.els.phy.innerHTML=''; document.getElementById('game').style.cursor='default'; },
    toMenu() { this.reset(); document.getElementById('menu-screen').style.display='flex'; document.getElementById('db-room').innerText="ROOM: MENU"; }
};

Engine.init();

// --- COMMANDS ---
Object.defineProperties(window, {
    'debug': { get: function() { const g=document.getElementById('game'); g.classList.toggle('debug'); return `Debug: ${g.classList.contains('debug')?"ON":"OFF"}`; } },
    'noclip': { get: function() { Engine.noclip=!Engine.noclip; document.getElementById('cheat-ind').style.display=Engine.noclip?'block':'none'; return `God Mode: ${Engine.noclip?"ON":"OFF"}`; } },
    'clear': { get: function() { localStorage.clear(); alert("Wiped"); window.location.href='../index.html'; return "Resetting..."; } }
});
window.menu='menu';
window.load = function(t) {
    if(typeof t==='number') { Engine.start(t); return `Level ${t}`; }
    const s=String(t).toLowerCase();
    if(s==='menu'||s==='save') { window.location.href='../index.html'; return "Returning..."; }
    if(s==='save1'||s==='s1') { location.reload(); return "Reloading..."; }
};
</script>
</body>
</html>