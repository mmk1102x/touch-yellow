<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Touch Yellow - Save 1</title>
    <!-- Hardcoded Icon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%23f2a922' stroke='%23333' stroke-width='10'/></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Roboto:wght@700&display=swap" rel="stylesheet">
    
    <style>
        /* --- CORE STYLES --- */
        * { box-sizing: border-box; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; user-select: none; touch-action: none; font-family: 'Roboto', sans-serif; display: flex; justify-content: center; align-items: center; }
        
        #game-container {
            width: 100%; max-width: 177.78vh; aspect-ratio: 16/9;
            position: relative; background: #000000; overflow: hidden;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            transition: background-color 0.3s;
            cursor: default;
        }

        .layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        #gfx-layer { z-index: 10; }
        #phy-layer { z-index: 20; }
        #ui-layer { z-index: 30; pointer-events: none; }

        /* VISUALS */
        .visual-path { position: absolute; background-color: #26a9e1; box-shadow: 0 0 0 1px #26a9e1; }
        .visual-goal { position: absolute; background-color: #f1a92a; box-shadow: 0 0 0 1px #f1a92a; }
        .visual-obs { position: absolute; background-color: #000000; } 
        .visual-btn { position: absolute; background-color: #33cc33; box-shadow: 0 0 0 1px #33cc33; }
        .visual-btn.activated { background-color: #228822; }

        .hitbox { position: absolute; opacity: 0; cursor: crosshair; }
        
        /* DEBUG STYLES */
        #game-container.debug { background-color: #330000; cursor: none; } 
        .debug .path-box { border: none; background: transparent; }
        .debug .goal-box { opacity: 0.8; border: 3px solid #00ff00; background: rgba(0, 255, 0, 0.3); z-index: 100; }
        .debug .obstacle-box { opacity: 0.8; border: 3px solid #ff0000; background: rgba(255, 0, 0, 0.5); z-index: 100; }
        .debug .trigger-box { opacity: 0.8; border: 3px solid #b0f; background: rgba(150, 0, 255, 0.4); z-index: 100; }
        .debug .btn-box { opacity: 0.8; border: 3px solid #0f0; background: rgba(0, 255, 0, 0.4); z-index: 100; }
        .debug .circle-btn { border: 3px solid #b0f !important; background-color: rgba(150, 0, 255, 0.4) !important; }

        /* DEBUG OVERLAY */
        #debug-info, #noclip-indicator {
            position: absolute; left: 10px; 
            color: lime; font-family: monospace; font-size: 14px; 
            background: rgba(0,0,0,0.8); padding: 5px; 
            z-index: 9999; display: none; pointer-events: none;
        }
        #debug-info { top: 10px; }
        #noclip-indicator { bottom: 10px; color: yellow; border: 1px solid yellow; font-size: 16px; font-weight: bold; }
        
        /* CROSSHAIR */
        .debug-line { position: fixed; background-color: cyan; pointer-events: none; z-index: 99999; display: none; }
        #debug-cross-x { width: 100%; height: 1px; left: 0; }
        #debug-cross-y { width: 1px; height: 100%; top: 0; }

        /* MENU (Blue Background) */
        .menu-content { pointer-events: auto; text-align: center; width: 100%; height: 100%; position: relative; background-color: #00b0f0; }
        .title { position: absolute; width: 100%; top: 10%; font-family: 'Roboto', sans-serif; font-weight: bold; color: black; font-size: 8cqi; line-height: 0.9; text-transform: capitalize; }
        .menu-btn-wrapper { position: absolute; display: flex; align-items: center; pointer-events: auto; }
        #btn-continue-wrap { left: 20%; bottom: 50%; height: 12%; }
        #btn-menu-wrap { left: 20%; bottom: 30%; height: 12%; }
        #btn-exit-wrap { left: 20%; bottom: 10%; height: 12%; }
        .circle-btn { height: 100%; aspect-ratio: 1/1; background-color: #f2a922; border-radius: 50%; border: 0.5cqi solid #b37a15; cursor: pointer; transition: transform 0.1s; }
        .label { font-size: 4cqi; font-weight: 900; color: #000; margin-left: 2cqi; white-space: nowrap; }

        @keyframes doorOpen { 0% { transform: translateY(0%); } 100% { transform: translateY(-120%); } }
        @keyframes slicerMove { 0% { transform: translateY(0%); } 50% { transform: translateY(200%); } 100% { transform: translateY(0%); } }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="debug-cross-x" class="debug-line"></div>
    <div id="debug-cross-y" class="debug-line"></div>

    <div id="game-container">
        <div id="gfx-layer" class="layer"></div>
        <div id="phy-layer" class="layer"></div>
        <div id="ui-layer" class="layer">
            <div id="debug-info">DEBUG: OFF</div>
            <div id="noclip-indicator">NOCLIP ON</div>
            
            <div id="menu-screen" class="menu-content">
                <h1 class="title">Got Save!</h1>
                <div id="btn-continue-wrap" class="menu-btn-wrapper"><div id="btn-continue" class="circle-btn"></div><div class="label"><-Continue</div></div>
                <div id="btn-menu-wrap" class="menu-btn-wrapper"><div class="circle-btn" onclick="Engine.goToMainMenu()"></div><div class="label"><-Menu</div></div>
                <div id="btn-exit-wrap" class="menu-btn-wrapper"><div class="circle-btn" onclick="Engine.exit()"></div><div class="label"><-Exit</div></div>
            </div>
        </div>
    </div>

    <script>
        const Logger = {
            log: (msg, type='info') => {
                const styles = { info: 'color: #26a9e1', success: 'color: #f1a92a; font-weight: bold', death: 'color: #ff4444; font-weight: bold', system: 'color: #888' };
                console.log(`%c[Save1] ${msg}`, styles[type] || styles.info);
            }
        };

        const Storage = {
            save: () => localStorage.setItem('touchYellow_save1', 'true'),
            clear: () => { 
                localStorage.clear();
                Logger.log("All Data Cleared", "system"); 
                alert("Data Cleared! Returning to Menu.");
                Engine.goToMainMenu();
            }
        };

        const LevelData = {
            6: (draw) => {
                const THICK = 14; const W_THICK = 7.875;
                draw.path(18, 38, 30, THICK * 1.5); 
                draw.path(40, 20, W_THICK, 60);
                draw.path(40, 20, 35, THICK);
                draw.path(40, 66, 65, THICK);
                draw.button(70, 20, W_THICK, THICK, (btnObj) => {
                    const door = Engine.findEntity('door-level6');
                    if (door && !door.opened) {
                        door.opened = true;
                        door.gfx.style.animation = "doorOpen 1s forwards";
                        door.hitbox.style.animation = "doorOpen 1s forwards";
                        btnObj.gfx.classList.add('activated');
                    }
                });
                draw.obstacle(60, 66, W_THICK, THICK, null, 'door-level6');
                draw.goal(90, 66, W_THICK, THICK, 7); 
            },
            7: (draw) => {
                const THICK = 14; 
                draw.path(10, 20, 10, 60);
                draw.path(10, 80, 80, THICK);
                draw.goal(80, 20, 7.875, THICK, 6); 
            }
        };

        const Engine = {
            container: document.getElementById('game-container'),
            layers: { gfx: document.getElementById('gfx-layer'), phy: document.getElementById('phy-layer'), ui: document.getElementById('ui-layer') },
            ui: { 
                menu: document.getElementById('menu-screen'), 
                debugInfo: document.getElementById('debug-info'),
                noclipInfo: document.getElementById('noclip-indicator'),
                crossX: document.getElementById('debug-cross-x'),
                crossY: document.getElementById('debug-cross-y'),
                continueBtn: document.getElementById('btn-continue')
            },
            state: { active: false, dragging: false, holdMode: false, debug: false, noclip: false, mouseX: 0, mouseY: 0, currentLevel: 6, hitboxes: [] },
            entities: {},

            init: function() {
                Storage.save();
                const savedHold = localStorage.getItem('touchYellow_holdMode') === 'true';
                const savedNoclip = localStorage.getItem('touchYellow_noclip') === 'true';
                this.state.holdMode = savedHold;
                if(savedNoclip) this.toggleNoclip(true);

                this.ui.continueBtn.onmousedown = () => this.startLevel(6);
                this.ui.continueBtn.ontouchstart = () => this.startLevel(6);

                window.addEventListener('mousemove', e => { 
                    this.state.mouseX = e.clientX; this.state.mouseY = e.clientY; 
                    if(this.state.debug) {
                        this.updateDebugInfo();
                        this.ui.crossX.style.top = e.clientY + 'px';
                        this.ui.crossY.style.left = e.clientX + 'px';
                    }
                });
                window.addEventListener('touchmove', e => { if (this.state.active) { e.preventDefault(); this.state.mouseX = e.touches[0].clientX; this.state.mouseY = e.touches[0].clientY; } }, {passive: false});
                window.addEventListener('mouseup', e => this.handleRelease(e));
                window.addEventListener('touchend', e => this.handleRelease(e));
                window.addEventListener('mousedown', e => { if(e.button === 2 && this.state.active) this.die("Panic Click"); });
                window.addEventListener('blur', () => { if (this.state.active && !this.state.noclip) this.die("Tab Focus Lost"); });

                requestAnimationFrame(this.gameLoop.bind(this));
                Logger.log("World 2 Engine Ready");
            },

            goToMainMenu: function() { window.location.href = "../index.html"; },

            builder: {
                path: (x, y, w, h) => Engine.registerCollider(x, y, w, h, 'path'),
                goal: (x, y, w, h, next) => Engine.registerCollider(x, y, w, h, 'goal', { next }),
                obstacle: (x, y, w, h, anim, name) => {
                    const c = Engine.registerCollider(x, y, w, h, 'obs', { name });
                    if (anim) { c.gfx.style.animation = anim; c.hitbox.style.animation = anim; }
                },
                button: (x, y, w, h, cb) => {
                    const c = Engine.registerCollider(x, y, w, h, 'btn');
                    c.onTouch = () => cb(c);
                }
            },

            registerCollider: function(x, y, w, h, type, data={}) {
                const gfx = document.createElement('div'); 
                const map = { 'path': 'visual-path', 'goal': 'visual-goal', 'obs': 'visual-obs', 'btn': 'visual-btn' };
                gfx.className = map[type] || 'visual-trig';
                gfx.style.left = x + '%'; gfx.style.top = y + '%'; gfx.style.width = w + '%'; gfx.style.height = h + '%';
                this.layers.gfx.appendChild(gfx);

                const phy = document.createElement('div'); 
                const debugMap = { 'path': 'path-box', 'goal': 'goal-box', 'obs': 'obstacle-box', 'btn': 'btn-box' };
                phy.className = `hitbox debug-box type-` + type + ' ' + (debugMap[type] || 'trigger-box');
                phy.style.left = x + '%'; phy.style.top = y + '%'; phy.style.width = w + '%'; phy.style.height = h + '%';
                if(!this.state.debug) phy.style.display = 'none';
                this.layers.phy.appendChild(phy);

                const collider = { x, y, w, h, type, gfx, hitbox: phy, ...data };
                this.state.hitboxes.push(collider);
                if (data.name) this.entities[data.name] = collider;
                return collider;
            },
            
            findEntity: function(name) { return this.entities[name]; },

            startLevel: function(lvl) {
                Logger.log(`Starting Level ${lvl}`);
                if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(e=>{});
                
                this.layers.gfx.innerHTML = ''; this.layers.phy.innerHTML = '';
                this.state.hitboxes = [];
                this.entities = {};
                this.ui.menu.style.display = 'none'; this.state.dragging = true;
                this.state.currentLevel = lvl;
                
                if (LevelData[lvl]) LevelData[lvl](this.builder);
                
                this.state.active = true;
                this.checkCollision(); // Check immediately
            },

            gameLoop: function() {
                if (this.state.active) this.checkCollision();
                requestAnimationFrame(this.gameLoop.bind(this));
            },

            checkCollision: function() {
                if (this.state.holdMode && !this.state.dragging) return;
                
                const rect = this.container.getBoundingClientRect();
                const mx = ((this.state.mouseX - rect.left) / rect.width) * 100;
                const my = ((this.state.mouseY - rect.top) / rect.height) * 100;

                let touchingSafe = false;
                let touchedGoal = false;
                let activeGoal = null;

                if (mx < 0 || mx > 100 || my < 0 || my > 100) { this.die("Out of Bounds"); return; }

                for (let c of this.state.hitboxes) {
                    const boxRect = c.hitbox.getBoundingClientRect();
                    const boxX = ((boxRect.left - rect.left) / rect.width) * 100;
                    const boxY = ((boxRect.top - rect.top) / rect.height) * 100;
                    const boxW = (boxRect.width / rect.width) * 100;
                    const boxH = (boxRect.height / rect.height) * 100;

                    if (mx >= boxX && mx <= boxX + boxW && my >= boxY && my <= boxY + boxH) {
                        if (c.type === 'path') touchingSafe = true;
                        if (c.type === 'btn') { touchingSafe = true; if(c.onTouch) c.onTouch(); }
                        if (c.type === 'goal') { touchingSafe = true; touchedGoal = true; activeGoal = c; }
                        if (c.type === 'obs') { this.die("Obstacle"); return; }
                    }
                }

                this.container.style.cursor = touchingSafe ? 'crosshair' : 'default';

                if (touchedGoal && activeGoal) {
                    this.win(activeGoal.next);
                    return;
                }

                if (!touchingSafe) { this.die("Void"); }
            },

            updateDebugInfo: function() {
                const target = document.elementFromPoint(this.state.mouseX, this.state.mouseY);
                this.ui.debugInfo.innerText = "TOUCHING: " + (target ? target.className : "NULL");
            },

            win: function(next) {
                this.state.active = false;
                Logger.log("Level Complete!", "success");
                this.startLevel(parseInt(next));
            },

            handleRelease: function(e) { if (e.button === 2) return; if (this.state.active && this.state.holdMode) this.die("Released Button"); },

            die: function(reason) {
                if (this.state.noclip) return;
                Logger.log(`Died: ${reason}`, "death");
                this.state.active = false; 
                if (this.state.currentLevel >= 6) { this.startLevel(6); } else { this.reset(); }
            },

            reset: function() {
                Logger.log("Resetting to Save Menu");
                this.state.active = false; this.state.dragging = false;
                this.ui.menu.style.display = 'block';
                this.layers.gfx.innerHTML = ''; this.layers.phy.innerHTML = '';
                this.state.hitboxes = [];
            },
            exit: function() { if (document.fullscreenElement) document.exitFullscreen(); window.close(); window.location.href = "https://google.com"; },
            toggleNoclip: function(v) { this.state.noclip = (v!==undefined)?v:!this.state.noclip; this.ui.noclipInfo.style.display = this.state.noclip ? 'block':'none'; },
            toggleDebug: function() { this.state.debug = !this.state.debug; this.container.classList.toggle('debug'); this.ui.debugInfo.style.display = this.state.debug ? 'block' : 'none'; this.ui.crossX.style.display = this.state.debug ? 'block' : 'none'; this.ui.crossY.style.display = this.state.debug ? 'block' : 'none'; document.querySelectorAll('.debug-box').forEach(b=>b.style.display=this.state.debug?'block':'none'); }
        };

        Engine.init();
        window.cmd = (c) => {
            if (c === 'hitbox') Engine.toggleDebug();
            if (c === 'noclip') Engine.toggleNoclip();
            if (c === 'load menu') Engine.goToMainMenu();
            if (c === 'clear') Storage.clear();
            if (c.startsWith('load level')) { const num = parseInt(c.split('level')[1]); if (!isNaN(num)) Engine.startLevel(num); }
        };
    </script>
</body>
</html>