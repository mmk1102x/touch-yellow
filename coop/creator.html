<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Touch Yellow: Co-op Creator</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- PURPLE THEME --- */
        body { margin:0; background:#2a002a; font-family:'Roboto', sans-serif; color:white; height:100vh; display:flex; flex-direction:column; overflow:hidden; user-select:none; }
        
        /* TOOLBAR */
        #toolbar { height:50px; background:#1a001a; display:flex; align-items:center; padding:0 15px; gap:10px; border-bottom:1px solid #404; overflow: visible; }
        button { background:#404; border:1px solid #606; color:#eee; padding:5px 10px; cursor:pointer; font-size:12px; border-radius:4px; white-space: nowrap; }
        button:hover { background:#606; } button.active { background:#808; border-color:#d0d; box-shadow:inset 0 0 4px #000; }
        button.prm { background:#d000d0; color:#fff; border-color:#f0f; font-weight:bold; }
        button.danger { background:#a33; border-color:#600; }
        
        .tool-group { display:flex; gap:5px; border-right:1px solid #404; padding-right:10px; align-items:center; }
        label { font-size:11px; color:#c0c; display:flex; align-items:center; gap:4px; cursor:pointer; }
        input[type=checkbox] { margin:0; }

        /* DROPDOWNS */
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content { display: none; position: absolute; right: 0; top: 100%; background-color: #303; min-width: 160px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.5); z-index: 20000; border: 1px solid #606; border-radius: 4px; }
        .dropdown-content button { color: #f0f; padding: 12px 16px; width: 100%; text-align: left; border: none; background: transparent; border-bottom: 1px solid #404; border-radius: 0; }
        .dropdown-content button:hover { background-color: #505; color: white; }
        .show { display: block; }

        /* WORKSPACE */
        #workspace { flex:1; display:flex; }
        #sidebar { width:280px; background:#2a002a; border-left:1px solid #404; padding:15px; display:flex; flex-direction:column; gap:15px; font-size:12px; overflow-y:auto; }
        #canvas { flex:1; position:relative; overflow:hidden; background-image:radial-gradient(#505 1px, transparent 1px); background-size:20px 20px; display:flex; justify-content:center; align-items:center; }
        #game-container { width:80%; aspect-ratio:16/9; position:relative; background:#000; box-shadow:0 0 50px #800080; border:1px solid #404; }
        
        /* OBJECTS */
        .obj { position:absolute; box-sizing:border-box; box-shadow: 0 0 0 1px rgba(0,0,0,0.2); }
        .t-path { background-color:#26a9e1; opacity:0.9; } 
        .t-goal { background-color:#f1a92a; opacity:0.9; } 
        .t-obs { background-color:#000; border:1px dashed #f00; opacity:0.8; }
        
        /* CO-OP SPECIFIC OBJECT STYLES */
        .t-btn { background-color:#330033; border: 2px solid #d0d; opacity:0.9; color: #d0d; } 
        .t-trig { background:rgba(150,0,255,0.3); border:2px solid #b0f; }
        .t-start { border:2px solid cyan; border-radius:50%; background:transparent; display:flex; justify-content:center; align-items:center; } 
        .t-start::after { content:"S"; color:cyan; font-weight:bold; }
        
        /* GIZMOS */
        .gizmo { position:absolute; border:2px solid #fff; pointer-events:none; z-index:9999 !important; }
        .handle { position:absolute; width:10px; height:10px; background:#fff; border:1px solid #000; pointer-events:auto; }
        .h-tl { top:-6px; left:-6px; cursor:nw-resize; } .h-tr { top:-6px; right:-6px; cursor:ne-resize; }
        .h-bl { bottom:-6px; left:-6px; cursor:sw-resize; } .h-br { bottom:-6px; right:-6px; cursor:se-resize; }
        .rotate-stem { position:absolute; top:-20px; left:50%; width:1px; height:20px; background:#fff; pointer-events:none; }
        .rotate-knob { position:absolute; top:-28px; left:50%; width:10px; height:10px; background:#f2a922; border:1px solid #fff; border-radius:50%; transform:translateX(-50%); cursor:grab; pointer-events:auto; }

        /* VISUALS */
        svg { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:9000; }
        path { stroke:#d0d; stroke-width:2; fill:none; stroke-dasharray:5; }
        .kf-node { position:absolute; width:10px; height:10px; background:#d0d; border:2px solid #fff; border-radius:50%; transform:translate(-50%,-50%); z-index:9500; cursor:grab; }

        /* SIDEBAR PROPS */
        .panel { background:#1a001a; border:1px solid #404; padding:8px; border-radius:4px; }
        .row { display:flex; justify-content:space-between; align-items:center; margin-bottom:5px; }
        .row label { color:#d0d; width:60px; }
        input[type=number], input[type=text] { flex:1; background:#000; border:1px solid #606; color:#fff; padding:4px; }
        .z-ctrl { display:flex; gap:2px; flex:1; } 
        .z-ctrl button { width:auto; padding:2px 8px; } .z-ctrl input { text-align:center; }
        
        #kf-list { max-height:100px; overflow-y:auto; border:1px solid #404; margin-top:5px; }
        .kf-item { display:flex; gap:5px; padding:2px; font-size:11px; }

        /* PLAY MODE */
        #play-layer { position:absolute; inset:0; pointer-events:none; z-index:200; display:none; }
        .paused { animation-play-state: paused !important; }
        #style-dump { display:none; }
        
        /* PLAY UI */
        #play-ui { position:fixed; top:0; left:0; width:100%; height:100%; z-index:20000; pointer-events:none; }
        .p-panel { position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.8); border:2px solid #d0d; padding:10px; border-radius:8px; pointer-events:auto; color:white; font-family:sans-serif; }
        #p-cursor { position:absolute; width:20px; height:20px; border-left:2px solid cyan; border-top:2px solid cyan; transform:translate(-50%,-50%) rotate(45deg); pointer-events:none; display:none; }
    </style>
    <style id="style-dump"></style>
</head>
<body>
    <!-- (Structure is identical to main creator, just purple styles applied above) -->
    <!-- Included truncated HTML structure for brevity, Script below is full -->
    <div id="toolbar">
        <div class="tool-group"><button class="prm" onclick="Ed.togglePlay()">‚ñ∂ PLAY</button></div>
        <div class="tool-group"><button id="t-sel" class="active" onclick="Ed.setTool('sel')">Select</button><button id="t-path" onclick="Ed.setTool('path')">Path</button><label><input type="checkbox" id="chk-snap" checked> Snap</label></div>
        <div class="tool-group"><button onclick="Ed.add('path')">+Blk</button><button onclick="Ed.add('obs')">+Obs</button><button onclick="Ed.add('goal')">+Goal</button><button onclick="Ed.add('btn')">+Btn</button><button onclick="Ed.add('trig')">+Trig</button><button onclick="Ed.add('start')">+Start</button></div>
        <div class="tool-group"><button onclick="HistorySys.undo()">Undo</button><button onclick="HistorySys.redo()">Redo</button></div>
        <div style="flex:1"></div>
        <div class="dropdown"><button onclick="toggleDrop('menu-imp')">IMPORT ‚ñ≤</button><div id="menu-imp" class="dropdown-content"><button onclick="StorageSys.load()">üíæ Local</button><button onclick="FileIO.import()">üìÇ File</button><button onclick="Ed.importHash()">üìù Hash</button></div></div>
        <div class="dropdown"><button class="prm" onclick="toggleDrop('menu-exp')">EXPORT ‚ñº</button><div id="menu-exp" class="dropdown-content"><button onclick="StorageSys.save()">üíæ Local</button><button onclick="FileIO.export()">üìÇ File</button><button onclick="Ed.exportHash()">üìù Hash</button><button onclick="Ed.exportCode()">üíª Code</button></div></div>
        <div class="tool-group" style="border:none; margin-left:10px;"><button class="danger" onclick="Ed.clear()">CLR</button><button class="danger" style="border-color:#f00" onclick="Ed.exit()">EXIT</button></div>
    </div>

    <div id="workspace">
        <div id="canvas"><div id="game-container"><div id="l-obj"></div><div id="l-giz"></div><svg id="l-svg"></svg><div id="l-pts"></div><div id="play-layer"></div></div></div>
        <div id="sidebar">
            <div id="props" style="display:none">
                <div class="panel"><div class="row"><span id="p-id" style="color:#d0d">OBJ</span></div><div class="row"><label>X</label><input type="number" id="v-x" onchange="Ed.set('x',this.value)"></div><div class="row"><label>Y</label><input type="number" id="v-y" onchange="Ed.set('y',this.value)"></div><div class="row"><label>W</label><input type="number" id="v-w" onchange="Ed.set('w',this.value)"></div><div class="row"><label>H</label><input type="number" id="v-h" onchange="Ed.set('h',this.value)"></div><div class="row"><label>Rot</label><input type="number" id="v-r" onchange="Ed.set('r',this.value)"></div><div class="row"><label>Z</label><div class="z-ctrl"><button onclick="Ed.modZ(-1)">-</button><input type="number" id="v-z" onchange="Ed.set('z',this.value)" value="10"><button onclick="Ed.modZ(1)">+</button></div></div></div>
                <div class="panel" style="margin-top:10px"><div class="row" style="color:#aaa">Logic</div><div class="row"><label>Tag</label><input type="text" id="v-tag" onchange="Ed.setStr('tag',this.value)"></div><div class="row"><label>Link</label><input type="text" id="v-link" onchange="Ed.setStr('link',this.value)"></div></div>
                <div class="panel" style="margin-top:10px"><div class="row" style="color:#aaa">Anim</div><div class="row"><label>Wait</label><input type="checkbox" id="v-wait" onchange="Ed.setBool('wait',this.checked)"></div><div class="row"><label>Loop</label><input type="checkbox" id="v-loop" checked onchange="Ed.setBool('loop',this.checked)"></div><div class="row"><label>Dur</label><input type="number" id="v-dur" value="2" onchange="Ed.set('dur',this.value)"></div><div class="row"><button onclick="Ed.addKf()">+ KF</button><button onclick="Ed.clearKf()">Reset</button></div><div id="kf-list"></div></div>
                <button class="danger" style="width:100%; margin-top:20px" onclick="Ed.del()">DELETE</button>
            </div>
            <div id="no-sel" style="text-align:center; color:#606; margin-top:50px;">Select Object</div>
        </div>
    </div>
    
    <div id="play-ui" style="display:none;"><div class="p-panel"><h3>CO-OP TEST</h3><label><input type="checkbox" id="chk-god" onchange="Ed.god=this.checked"> God Mode</label><hr><button class="danger" onclick="Ed.togglePlay()">EXIT</button></div><div id="p-cursor"></div></div>

<script>
// --- CO-OP EDITOR LOGIC ---
// (Mostly identical to main editor but with different storage key and default values)

function toggleDrop(id) { document.querySelectorAll('.dropdown-content').forEach(e=>e.classList.remove('show')); document.getElementById(id).classList.toggle('show'); }
window.onclick = function(e) { if (!e.target.matches('.dropdown button')) { document.querySelectorAll('.dropdown-content').forEach(e=>e.classList.remove('show')); } }

const HistorySys={stack:[],future:[],push(){if(this.stack.length>50)this.stack.shift();this.stack.push(JSON.parse(JSON.stringify(Ed.objs)));this.future=[];Ed.dirty=true;},undo(){if(this.stack.length){this.future.push(JSON.parse(JSON.stringify(Ed.objs)));Ed.objs=this.stack.pop();Ed.sel=null;Ed.render();}},redo(){if(this.future.length){this.stack.push(JSON.parse(JSON.stringify(Ed.objs)));Ed.objs=this.future.pop();Ed.sel=null;Ed.render();}}};
window.addEventListener('keydown',(e)=>{if(e.target.tagName==='INPUT')return;if((e.ctrlKey||e.metaKey)&&e.key==='z'){e.preventDefault();HistorySys.undo();}if((e.ctrlKey||e.metaKey)&&e.key==='y'){e.preventDefault();HistorySys.redo();}if(e.key==='Delete')Ed.del();if(e.key==='`'||e.key==='Escape'){if(Ed.playing)Ed.togglePlay();}});

const StorageSys={
    KEY:'ty_coop_level_data', // UNIQUE KEY FOR CO-OP
    save:()=>{ try{ const d=Ed.pack(); localStorage.setItem(StorageSys.KEY, JSON.stringify(d)); Ed.dirty=false; alert("Co-op Level Saved!"); }catch(e){alert("Error");} }, 
    load:()=>{ const s=localStorage.getItem(StorageSys.KEY); if(s){ Ed.unpack(JSON.parse(s)); alert("Loaded!"); }else alert("No Save"); }
};
const CookieSys={ save:StorageSys.save, load:StorageSys.load };

const FileIO = {
    export: () => { const d=Ed.pack(); const b=new Blob([JSON.stringify(d)],{type:"text/plain"}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); const n=prompt("Filename:","coop_level"); if(!n)return; a.download=n+".level"; document.body.appendChild(a); a.click(); document.body.removeChild(a); Ed.dirty=false; },
    import: () => { const i=document.createElement('input'); i.type='file'; i.accept='.level'; i.onchange=e=>{ const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=ev=>{ try{ Ed.unpack(JSON.parse(ev.target.result)); alert("Imported!"); }catch(err){alert("Invalid");} }; r.readAsText(f); }; i.click(); }
};

const Ed = {
    objs: [], sel: null, tool: 'sel', drag: null, playing: false, dirty: false, god: false, mx:0, my:0,
    els: { obj:document.getElementById('l-obj'), giz:document.getElementById('l-giz'), svg:document.getElementById('l-svg'), pts:document.getElementById('l-pts'), props:document.getElementById('props'), no:document.getElementById('no-sel') },
    
    init() { 
        const cvs = document.getElementById('canvas');
        cvs.addEventListener('mousedown', (e) => this.down(e));
        cvs.addEventListener('mousemove', (e) => this.move(e));
        cvs.addEventListener('mouseup',   (e) => this.up(e));
        window.addEventListener('mousemove', e => { 
            this.mx=e.clientX; this.my=e.clientY;
            const c=document.getElementById('p-cursor');
            if(this.playing && c) { c.style.display='block'; c.style.left=e.clientX+'px'; c.style.top=e.clientY+'px'; }
        });
        this.add('start', 5, 50, 6, 10); 
    },
    
    // Schema: [Type, X, Y, W, H, KFS, Tag, Link, Wait, Dur, Z, Rot, Loop]
    pack() { return this.objs.map(o=>[ ['path','obs','goal','start','btn','trig'].indexOf(o.type), o.x, o.y, o.w, o.h, o.kfs, o.tag, o.link, o.wait?1:0, o.dur, o.z||10, o.r||0, o.loop===false?0:1 ]); },
    unpack(d) { this.objs=d.map(r=>({ id:Math.random(), type:['path','obs','goal','start','btn','trig'][r[0]], x:r[1], y:r[2], w:r[3], h:r[4], kfs:r[5]||[], tag:r[6]||"", link:r[7]||"", wait:!!r[8], dur:r[9]||2, z:r[10]||10, r:r[11]||0, loop:r[12]!==0 })); this.render(); },

    add(type,x=40,y=40,w=10,h=10) { 
        HistorySys.push(); 
        let z=10; if(type==='obs')z=20; if(type==='btn')z=15;
        this.objs.push({id:Math.random(), type, x, y, w, h, r:0, z, kfs:[], tag:"", link:"", wait:false, dur:2, loop:true });
        this.render(); 
    },

    setTool(t) { this.tool=t; document.querySelectorAll('#toolbar button').forEach(b=>b.classList.remove('active')); document.getElementById(t==='sel'?'t-sel':'t-path').classList.add('active'); this.render(); },

    render() {
        if(this.playing) return;
        ['obj','giz','pts'].forEach(k=>this.els[k].innerHTML=''); this.els.svg.innerHTML='';
        [...this.objs].sort((a,b)=>(a.z||10)-(b.z||10)).forEach(o => {
            const el = document.createElement('div');
            el.className = `obj t-${o.type}`;
            Object.assign(el.style, { left:o.x+'%', top:o.y+'%', width:o.w+'%', height:o.h+'%', transform:`rotate(${o.r}deg)`, zIndex:o.z||10 });
            el.onmousedown = (e) => this.startDrag(e, o, 'move');
            this.els.obj.appendChild(el);

            if(this.sel === o) {
                const g = document.createElement('div'); g.className='gizmo';
                Object.assign(g.style, { left:o.x+'%', top:o.y+'%', width:o.w+'%', height:o.h+'%', transform:`rotate(${o.r}deg)`, zIndex:9999 });
                ['tl','tr','bl','br'].forEach(p => { const h = document.createElement('div'); h.className=`handle h-${p}`; h.onmousedown = (e) => this.startDrag(e, o, 'scale', p); g.appendChild(h); });
                const stem = document.createElement('div'); stem.className='rotate-stem'; const knob = document.createElement('div'); knob.className='rotate-knob';
                knob.onmousedown = (e) => this.startDrag(e, o, 'rotate'); g.append(stem, knob);
                this.els.giz.appendChild(g);
                this.renderPath(o);
            }
        });
        this.updateUI();
    },

    renderPath(o) {
        if(!o.kfs.length && this.tool!=='path') return;
        let d = `M ${o.x+o.w/2} ${o.y+o.h/2}`;
        o.kfs.forEach((k, i) => {
            const ax = o.x+o.w/2 + (k.x/100*o.w);
            const ay = o.y+o.h/2 + (k.y/100*o.h);
            d += ` L ${ax} ${ay}`;
            const pt=document.createElement('div'); pt.className='kf-node'; pt.style.left=ax+'%'; pt.style.top=ay+'%';
            pt.onmousedown = (e) => this.startDrag(e, o, 'kf', i);
            this.els.pts.appendChild(pt);
        });
        const p = document.createElementNS("http://www.w3.org/2000/svg","path"); p.setAttribute("d",d); this.els.svg.appendChild(p);
    },

    startDrag(e, o, mode, handle) {
        e.stopPropagation();
        if(this.tool==='path' && mode==='move') { this.addKf(e,o); return; }
        this.sel = o; this.render(); HistorySys.push();
        this.drag = { mode, o, sx:e.clientX, sy:e.clientY, handle, ox:o.x, oy:o.y, ow:o.w, oh:o.h, or:o.r, kfIdx: (mode==='kf'?handle:null), kfx: (mode==='kf'?o.kfs[handle].x:0), kfy: (mode==='kf'?o.kfs[handle].y:0) };
    },

    move(e) {
        if(!this.drag) return;
        const r = document.getElementById('game-container').getBoundingClientRect();
        const dx = (e.clientX - this.drag.sx)/r.width*100; const dy = (e.clientY - this.drag.sy)/r.height*100;
        const o = this.drag.o; const snap = document.getElementById('chk-snap').checked;

        if(this.drag.mode === 'kf') {
            const i = this.drag.kfIdx;
            let nx = this.drag.kfx + (dx/o.w*100); let ny = this.drag.kfy + (dy/o.h*100);
            if(snap) { nx=Math.round(nx/10)*10; ny=Math.round(ny/10)*10; }
            o.kfs[i].x = nx; o.kfs[i].y = ny;
        }
        else if(this.drag.mode === 'move') {
            o.x = this.drag.ox + dx; o.y = this.drag.oy + dy;
            if(snap) { o.x=Math.round(o.x); o.y=Math.round(o.y); }
        } 
        else if(this.drag.mode === 'scale') {
            let nw=o.w, nh=o.h, nx=o.x, ny=o.y;
            if(this.drag.handle.includes('r')) nw = Math.max(1, this.drag.ow + dx);
            if(this.drag.handle.includes('l')) { let d = Math.min(this.drag.ow-1, dx); nw = this.drag.ow - d; nx = this.drag.ox + d; }
            if(this.drag.handle.includes('b')) nh = Math.max(1, this.drag.oh + dy);
            if(this.drag.handle.includes('t')) { let d = Math.min(this.drag.oh-1, dy); nh = this.drag.oh - d; ny = this.drag.oy + d; }
            if(snap) { nw=Math.round(nw); nh=Math.round(nh); nx=Math.round(nx); ny=Math.round(ny); }
            o.x=nx; o.y=ny; o.w=nw; o.h=nh;
        }
        else if(this.drag.mode === 'rotate') {
            const cx = r.left + (o.x + o.w/2)/100 * r.width; const cy = r.top + (o.y + o.h/2)/100 * r.height;
            const angle = Math.atan2(e.clientY - cy, e.clientX - cx) * (180/Math.PI);
            let rot = angle + 90; if(snap) rot = Math.round(rot/15)*15; o.r = rot;
        }
        this.render(); this.updateUI();
    },

    up() { this.drag = null; }, down(e) { if(e.target.id === 'game-container') { this.sel=null; this.render(); } },

    updateUI() {
        if(!this.sel) { this.els.props.style.display='none'; this.els.no.style.display='block'; return; }
        this.els.props.style.display='block'; this.els.no.style.display='none';
        ['x','y','w','h','r','dur','z'].forEach(k => { const el = document.getElementById('v-'+k); if(el) el.value = Math.round((this.sel[k]||(k==='z'?10:0))*100)/100; });
        document.getElementById('p-id').innerText = this.sel.type;
        document.getElementById('v-tag').value = this.sel.tag; document.getElementById('v-link').value = this.sel.link;
        document.getElementById('v-wait').checked = this.sel.wait; document.getElementById('v-loop').checked = (this.sel.loop !== false);
        const l = document.getElementById('kf-list'); l.innerHTML='';
        this.sel.kfs.forEach((k,i) => l.innerHTML += `<div class="kf-item"><span class="kf-idx">#${i+1}</span> X:<input type="number" value="${Math.round(k.x)}" onchange="Ed.setKf(${i},'x',this.value)"> Y:<input type="number" value="${Math.round(k.y)}" onchange="Ed.setKf(${i},'y',this.value)"></div>`);
    },

    set(k,v) { if(this.sel) { HistorySys.push(); this.sel[k]=parseFloat(v); this.render(); } },
    setStr(k,v) { if(this.sel) { HistorySys.push(); this.sel[k]=v; } },
    setBool(k,v) { if(this.sel) { HistorySys.push(); this.sel[k]=v; } },
    modZ(d) { if(this.sel) { HistorySys.push(); this.sel.z=(this.sel.z||10)+d; this.render(); } },
    setKf(i,k,v) { if(this.sel) { HistorySys.push(); this.sel.kfs[i][k]=parseFloat(v); this.render(); } },
    
    del() { if(this.sel) { HistorySys.push(); this.objs=this.objs.filter(o=>o!==this.sel); this.sel=null; this.render(); } },
    clear() { if(confirm("Clear?")) { HistorySys.push(); this.objs=[]; this.render(); } },
    addKf(e,o) { const t=o||this.sel; if(t) { HistorySys.push(); t.kfs.push({x:10,y:10}); this.render(); } },
    clearKf() { if(this.sel) { HistorySys.push(); this.sel.kfs=[]; this.render(); } },

    exit() { if(this.dirty) { if(confirm("Unsaved changes! Exit?")) window.location.href='../index.html'; } else window.location.href='../index.html'; },
    
    exportHash() { const d=this.pack(); prompt("Level Hash:", btoa(JSON.stringify(d))); },
    importHash() { const s=prompt("Paste Hash:"); if(s) try { this.unpack(JSON.parse(atob(s))); } catch(e) { alert("Invalid"); } },
    exportCode() {
        let js = `// Level Code\n(d) => {\n`;
        this.objs.forEach(o => {
            let animStr = "null";
            if(o.kfs.length) { const iter = (o.loop !== false) ? 'infinite' : 'forwards'; animStr = `"customAnim ${o.dur}s linear ${iter}"`; }
            const z = o.z && o.z !== 10 ? `, z:${o.z}` : '';
            if(o.type==='path') js += `    d.path(${o.x}, ${o.y}, ${o.w}, ${o.h}${z});\n`;
            if(o.type==='obs') js += `    const obs = d.obs(${o.x}, ${o.y}, ${o.w}, ${o.h}, ${animStr}); ${z?`obs.vis.style.zIndex=${o.z};`:''}\n`;
            if(o.type==='goal') js += `    d.goal(${o.x}, ${o.y}, ${o.w}, ${o.h}, 'next');\n`;
            if(o.type==='start') js += `    d.start(${o.x}, ${o.y}, ${o.w}, ${o.h});\n`;
            if(o.type==='btn') js += `    const b = d.btn(${o.x}, ${o.y}, ${o.w}, ${o.h});\n`;
        });
        js += `}`;
        console.log(js); alert("Code logged to Console (F12)");
    },

    togglePlay() {
        this.playing = !this.playing;
        const pl = document.getElementById('play-layer');
        if(this.playing) {
            document.documentElement.requestFullscreen().catch(e=>{});
            pl.style.display='block'; pl.innerHTML='';
            document.getElementById('play-ui').style.display='block';
            this.els.obj.style.display='none'; this.els.giz.style.display='none';
            let css = "";
            this.objs.forEach(o => {
                const el = document.createElement('div');
                el.className = `obj t-${o.type} ${o.wait?'paused':''}`;
                if(o.tag) el.id = "run-"+o.tag;
                Object.assign(el.style, { left:o.x+'%', top:o.y+'%', width:o.w+'%', height:o.h+'%', zIndex:o.z||10, transform:`rotate(${o.r}deg)` });
                
                if(Array.isArray(o.kfs) && o.kfs.length) {
                    const nm = `anim-${Math.random().toString(36).substr(2,5)}`;
                    css += `@keyframes ${nm} { 0% { transform: translate(0,0) rotate(${o.r}deg); } `;
                    o.kfs.forEach((k,i) => {
                        const pct = Math.round((i+1)/(o.kfs.length+1)*100);
                        css += `${pct}% { transform: translate(${k.x}%, ${k.y}%) rotate(${o.r}deg); } `;
                    });
                    css += `100% { transform: translate(0,0) rotate(${o.r}deg); } } `;
                    const iter = (o.loop !== false) ? 'infinite' : 'forwards';
                    el.style.animation = `${nm} ${o.dur}s linear ${iter}`;
                }
                o._el = el;
                pl.appendChild(el);
            });
            document.getElementById('style-dump').innerHTML = css;
            this.physicsLoop();
            
        } else {
            if(document.fullscreenElement) document.exitFullscreen();
            pl.style.display='none'; document.getElementById('play-ui').style.display='none';
            this.els.obj.style.display='block'; this.els.giz.style.display='block'; 
            this.render();
        }
    },

    physicsLoop() {
        if(!this.playing) return;
        requestAnimationFrame(() => this.physicsLoop());
        const rect = document.getElementById('game-container').getBoundingClientRect();
        const px = ((this.mx - rect.left) / rect.width) * 100;
        const py = ((this.my - rect.top) / rect.height) * 100;
        
        if((px<0 || px>100 || py<0 || py>100) && !this.god) return this.death();

        let safe = false;
        for(let o of this.objs) {
            if(!o._el) continue;
            const r = o._el.getBoundingClientRect();
            const relX = this.mx - rect.left;
            const relY = this.my - rect.top;
            const bx = (r.left - rect.left);
            const by = (r.top - rect.top);

            if(relX >= bx && relX <= bx+r.width && relY >= by && relY <= by+r.height) {
                if(o.type === 'obs' && !this.god) return this.death();
                if(o.type === 'path' || o.type === 'start') safe = true;
                if((o.type==='btn' || o.type==='trig') && o.link) {
                    safe = true;
                    // Co-op Logic Check (Pressure Plate logic not in Single Player Creator yet, defaulting to Trigger logic)
                    const t = document.getElementById("run-"+o.link);
                    if(t) t.classList.remove('paused');
                    if(o.type==='btn') o._el.style.backgroundColor = '#d000d0'; // Purple feedback for co-op creator
                }
            }
        }
        if(!safe && !this.god) this.death();
    },

    death() {
        document.body.style.background = '#500';
        this.playing = false;
        setTimeout(() => {
            document.body.style.background = '#2a002a';
            this.playing = true; 
            this.togglePlay(); this.togglePlay(); 
        }, 100);
    },
    
    togDbg() { this.debug=!this.debug; document.getElementById('play-layer').classList.toggle('debug-view', this.debug); }
};

Ed.init();
</script>
</body>
</html>