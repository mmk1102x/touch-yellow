<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Touch Yellow - Creator</title>
    <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Roboto:wght@700&display=swap" rel="stylesheet">
    <style>
        /* --- COMPACT CSS --- */
        * { box-sizing: border-box; }
        body { margin: 0; width: 100vw; height: 100vh; background: #222; font-family: 'Roboto', sans-serif; display: flex; flex-direction: column; overflow: hidden; color: white; user-select: none; }
        
        /* UI LAYOUT */
        #toolbar { height: 50px; background: #333; display: flex; align-items: center; padding: 0 15px; border-bottom: 2px solid #444; gap: 10px; }
        #workspace { flex: 1; display: flex; position: relative; }
        #sidebar { width: 260px; background: #2a2a2a; border-left: 2px solid #444; padding: 10px; overflow-y: auto; z-index: 200; }
        #canvas-wrapper { flex: 1; display: flex; justify-content: center; align-items: center; background-image: radial-gradient(#444 1px, transparent 1px); background-size: 20px 20px; position: relative; overflow: hidden; }
        
        /* GAME CONTAINER */
        #game-container { width: 80%; aspect-ratio: 16/9; position: relative; background: #000; box-shadow: 0 0 50px #000; border: 1px solid #444; }
        .play-active #game-container { border-color: lime; }

        /* OBJECTS */
        .obj { position: absolute; box-sizing: border-box; transform-origin: center center; }
        .v-path { background: #26a9e1; box-shadow: 0 0 0 1px #26a9e1; }
        .v-goal { background: #f1a92a; box-shadow: 0 0 0 1px #f1a92a; }
        .v-obs { background: #000; border: 1px dashed #555; }
        .v-btn { background: #33cc33; box-shadow: 0 0 0 1px #33cc33; }
        .v-trig { background: rgba(150,0,255,0.2); border: 2px solid #b0f; }
        .v-start { border: 2px solid lime; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: lime; font-weight: bold; font-size: 10px; }
        .v-start::after { content: "S"; }

        /* GIZMOS */
        .gizmo-box { position: absolute; pointer-events: none; z-index: 1000; border: 2px solid white; }
        .handle { position: absolute; width: 10px; height: 10px; background: white; border: 1px solid black; pointer-events: auto; }
        .h-tl { top: -6px; left: -6px; cursor: nw-resize; } .h-tr { top: -6px; right: -6px; cursor: ne-resize; }
        .h-bl { bottom: -6px; left: -6px; cursor: sw-resize; } .h-br { bottom: -6px; right: -6px; cursor: se-resize; }
        .rot-stem { position: absolute; top: -20px; left: 50%; width: 1px; height: 20px; background: white; }
        .rot-knob { position: absolute; top: -28px; left: 50%; width: 10px; height: 10px; background: #f2a922; border-radius: 50%; transform: translateX(-50%); cursor: grab; pointer-events: auto; }

        /* PATH EDITOR */
        svg#path-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 900; }
        .path-line { stroke: #f2a922; stroke-width: 2; stroke-dasharray: 5; fill: none; }
        .path-point { position: absolute; width: 10px; height: 10px; background: #f2a922; border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%); cursor: move; z-index: 950; pointer-events: auto; }

        /* UI COMPONENTS */
        button { background: #444; border: 1px solid #666; color: white; padding: 5px 8px; cursor: pointer; border-radius: 3px; font-size: 11px; }
        button:hover { background: #555; }
        button.primary { background: #f2a922; color: black; border-color: #b37a15; font-weight: bold; }
        button.danger { background: #c33; border-color: #922; }
        button.active { background: #666; box-shadow: inset 0 0 5px #000; }
        
        .prop-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .prop-row label { font-size: 11px; color: #aaa; }
        .prop-row input { width: 50px; background: #111; border: 1px solid #444; color: white; padding: 3px; }
        
        #play-overlay { position: absolute; top: 10px; left: 10px; pointer-events: none; display: none; color: lime; font-weight: bold; z-index: 9999; text-shadow: 1px 1px 0 #000; }
        #dynamic-css { display: none; }
        
        /* MODAL */
        #kf-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: #333; padding: 15px; border-radius: 5px; width: 400px; border: 2px solid #f2ef45; }
        .kf-list { max-height: 300px; overflow-y: auto; margin: 10px 0; background: #222; padding: 5px; }
        .kf-item { display: flex; gap: 5px; margin-bottom: 5px; }
    </style>
    <style id="dynamic-css"></style>
</head>
<body>

    <div id="toolbar">
        <button class="primary" onclick="Creator.togglePlay()">â–¶ PLAY</button>
        <span style="width:1px;height:20px;background:#555;margin:0 5px;"></span>
        <button id="t-sel" class="active" onclick="Creator.setTool('select')">Select</button>
        <button id="t-path" onclick="Creator.setTool('path')">Anim Path</button>
        <label style="margin-left:10px"><input type="checkbox" id="chk-snap" checked> Snap</label>
        <span style="width:1px;height:20px;background:#555;margin:0 5px;"></span>
        <button onclick="Creator.add('path')">+Path</button>
        <button onclick="Creator.add('obs')">+Obs</button>
        <button onclick="Creator.add('goal')">+Goal</button>
        <button onclick="Creator.add('btn')">+Btn</button>
        <button onclick="Creator.add('trig')">+Trig</button>
        <button onclick="Creator.add('start')">+Start</button>
        <span style="flex:1"></span>
        <button onclick="Creator.export()">Export</button>
        <button onclick="Creator.import()">Import</button>
        <button class="danger" onclick="Creator.clear()">Clear</button>
    </div>

    <div id="workspace">
        <div id="canvas-wrapper" onmousedown="Creator.onDown(event)" onmousemove="Creator.onMove(event)" onmouseup="Creator.onUp(event)">
            <div id="game-container">
                <div id="obj-layer"></div>
                <div id="engine-layer"></div>
                <svg id="path-overlay"></svg>
                <div id="path-points"></div>
                <div id="gizmo-layer"></div>
                <div id="play-overlay">Move to Start...</div>
            </div>
        </div>

        <div id="sidebar">
            <h4 style="margin:0 0 10px 0; color:#f2a922">PROPERTIES</h4>
            <div id="props" style="display:none;">
                <div class="prop-row"><label>X%</label><input type="number" id="p-x" onchange="Creator.set('x',this.value)"></div>
                <div class="prop-row"><label>Y%</label><input type="number" id="p-y" onchange="Creator.set('y',this.value)"></div>
                <div class="prop-row"><label>W%</label><input type="number" id="p-w" onchange="Creator.set('w',this.value)"></div>
                <div class="prop-row"><label>H%</label><input type="number" id="p-h" onchange="Creator.set('h',this.value)"></div>
                <div class="prop-row"><label>Rot</label><input type="number" id="p-r" onchange="Creator.set('r',this.value)"></div>
                
                <div id="g-anim" style="display:none; border-top:1px solid #444; margin-top:10px; padding-top:10px;">
                    <label>Animation</label><input type="text" id="p-anim" style="width:100%" onchange="Creator.set('anim',this.value)">
                    <button style="width:100%;margin-top:5px" onclick="Keyframes.open()">Edit Path</button>
                </div>
                
                <div id="g-goal" style="display:none; border-top:1px solid #444; margin-top:10px; padding-top:10px;">
                    <div class="prop-row"><label>Next</label><input type="text" id="p-next" onchange="Creator.set('next',this.value)"></div>
                    <div class="prop-row"><label>Hold</label><input type="number" id="p-hold" onchange="Creator.set('holdTime',this.value)"></div>
                </div>

                <button class="danger" style="width:100%; margin-top:20px;" onclick="Creator.del()">DELETE</button>
            </div>
        </div>
    </div>

    <div id="kf-modal"><div class="modal-content"><h3>Animation Path</h3><div id="kf-list" class="kf-list"></div><button onclick="Keyframes.add()">+ Step</button><div style="margin-top:10px;text-align:right"><button onclick="document.getElementById('kf-modal').style.display='none'">Done</button></div></div></div>

    <script>
        // --- HELPER ---
        const el = (tag, cls, style='') => { const e=document.createElement(tag); e.className=cls; e.style.cssText=style; return e; };

        const Creator = {
            objs: [], sel: [], tool: 'select', playing: false, drag: null,
            ui: { 
                cont: document.getElementById('game-container'),
                objL: document.getElementById('obj-layer'),
                engL: document.getElementById('engine-layer'),
                gizL: document.getElementById('gizmo-layer'),
                pathL: document.getElementById('path-overlay'),
                ptsL: document.getElementById('path-points'),
                props: document.getElementById('props')
            },

            init() {
                this.add('start', 10, 50, 5, 9);
                window.onkeydown = e => { if(e.key==='Delete') this.del(); if(e.key==='v') this.setTool('select'); if(e.key==='p') this.setTool('path'); };
            },

            add(type, x=40, y=40, w=10, h=10) {
                if(type==='path') { w=20; h=14; }
                const o = { id: Date.now()+Math.random(), type, x, y, w, h, r:0, anim:'', next:'menu', holdTime:0, kf:[] };
                this.objs.push(o); this.render(); this.select([o.id]);
            },

            render() {
                this.ui.objL.innerHTML = '';
                this.objs.forEach(o => {
                    const d = el('div', `obj v-${o.type}`, `left:${o.x}%;top:${o.y}%;width:${o.w}%;height:${o.h}%;transform:rotate(${o.r}deg)`);
                    d.dataset.id = o.id;
                    this.ui.objL.appendChild(d);
                });
                this.renderGizmos();
            },

            renderGizmos() {
                this.ui.gizL.innerHTML = '';
                if(this.tool !== 'select') return;
                this.sel.forEach(id => {
                    const o = this.objs.find(x=>x.id===id); if(!o) return;
                    const b = el('div', 'gizmo-box', `left:${o.x}%;top:${o.y}%;width:${o.w}%;height:${o.h}%;transform:rotate(${o.r}deg)`);
                    ['tl','tr','bl','br'].forEach(p => {
                        const h = el('div', `handle h-${p}`);
                        h.onmousedown = e => this.startDrag(e, 'scale', o, p);
                        b.appendChild(h);
                    });
                    const k = el('div', 'rot-knob');
                    k.onmousedown = e => this.startDrag(e, 'rotate', o);
                    b.appendChild(el('div', 'rot-stem')); b.appendChild(k);
                    this.ui.gizL.appendChild(b);
                });
            },

            select(ids) {
                this.sel = ids; this.renderGizmos(); this.updateUI();
                if(this.tool==='path') this.renderPath();
            },

            onDown(e) {
                if(this.playing) return;
                const t = e.target.closest('.obj');
                const r = this.ui.cont.getBoundingClientRect();
                const mx = (e.clientX - r.left)/r.width*100, my = (e.clientY - r.top)/r.height*100;

                if(this.tool==='path' && this.sel.length===1) { Keyframes.addPoint(mx, my); return; }

                if(t) {
                    const id = parseFloat(t.dataset.id);
                    if(!this.sel.includes(id)) this.select([id]);
                    this.startDrag(e, 'move', this.objs.find(o=>o.id===id));
                } else if(this.tool==='select') this.select([]);
            },

            startDrag(e, mode, o, h) {
                e.stopPropagation(); e.preventDefault();
                this.drag = { mode, id: o.id, h, sx: e.clientX, sy: e.clientY, ox: o.x, oy: o.y, ow: o.w, oh: o.h, or: o.r };
            },

            onMove(e) {
                if(!this.drag) return;
                const r = this.ui.cont.getBoundingClientRect();
                const dx = (e.clientX - this.drag.sx)/r.width*100, dy = (e.clientY - this.drag.sy)/r.height*100;
                const o = this.objs.find(x=>x.id===this.drag.id);
                const snap = document.getElementById('chk-snap').checked;
                
                if(this.drag.mode==='move') {
                    o.x = this.drag.ox + dx; o.y = this.drag.oy + dy;
                    if(snap) { o.x=Math.round(o.x); o.y=Math.round(o.y); }
                } else if(this.drag.mode==='scale') {
                    let nw=this.drag.ow, nh=this.drag.oh, nx=this.drag.ox, ny=this.drag.oy;
                    if(this.drag.h.includes('r')) nw += dx;
                    if(this.drag.h.includes('l')) { nw -= dx; nx += dx; }
                    if(this.drag.h.includes('b')) nh += dy;
                    if(this.drag.h.includes('t')) { nh -= dy; ny += dy; }
                    if(snap) { nw=Math.round(nw); nh=Math.round(nh); nx=Math.round(nx); ny=Math.round(ny); }
                    o.w=Math.max(1,nw); o.h=Math.max(1,nh); o.x=nx; o.y=ny;
                } else {
                    o.r = this.drag.or + (dx*5);
                    if(snap) o.r = Math.round(o.r/15)*15;
                }
                this.render(); this.updateUI();
            },

            onUp() { this.drag = null; },

            updateUI() {
                if(this.sel.length!==1) { this.ui.props.style.display='none'; return; }
                const o = this.objs.find(x=>x.id===this.sel[0]);
                this.ui.props.style.display='block';
                ['x','y','w','h','r'].forEach(k => document.getElementById('p-'+k).value = Math.round(o[k]*10)/10);
                document.getElementById('p-anim').value = o.anim;
                document.getElementById('p-next').value = o.next;
                document.getElementById('p-hold').value = o.holdTime;
                document.getElementById('g-anim').style.display = ['obs','goal'].includes(o.type)?'block':'none';
                document.getElementById('g-goal').style.display = o.type==='goal'?'block':'none';
            },

            set(k, v) {
                const o = this.objs.find(x=>x.id===this.sel[0]);
                if(o) { o[k] = isNaN(v)?v:parseFloat(v); this.render(); }
            },

            del() { this.objs = this.objs.filter(o=>!this.sel.includes(o.id)); this.select([]); this.render(); },

            setTool(t) {
                this.tool = t;
                document.getElementById('t-sel').className = t==='select'?'active':'';
                document.getElementById('t-path').className = t==='path'?'active':'';
                if(t==='path') this.renderPath(); else { this.ui.pathL.innerHTML=''; this.ui.ptsL.innerHTML=''; }
            },

            renderPath() {
                this.ui.pathL.innerHTML=''; this.ui.ptsL.innerHTML='';
                const o = this.objs.find(x=>x.id===this.sel[0]);
                if(!o) return;
                const cx = o.x+o.w/2, cy = o.y+o.h/2;
                let d = `M ${cx} ${cy}`;
                o.kf.forEach(k => {
                    const px = cx + (k.x/100*o.w), py = cy + (k.y/100*o.h);
                    d += ` L ${px} ${py}`;
                    this.ui.ptsL.appendChild(el('div', 'path-point', `left:${px}%;top:${py}%`));
                });
                const p = document.createElementNS("http://www.w3.org/2000/svg", "path");
                p.setAttribute("d", d); p.setAttribute("class", "path-line");
                this.ui.pathL.setAttribute("viewBox", "0 0 100 100");
                this.ui.pathL.appendChild(p);
            },

            exportCode() {
                let css='', js='(draw) => {\n';
                this.objs.forEach(o => {
                    if(o.kf.length) {
                        const n = "a"+Math.floor(o.id).toString(36);
                        css += `@keyframes ${n} { 0% { transform:translate(0,0); } `;
                        o.kf.forEach((k,i) => css += `${Math.round((i+1)/(o.kf.length+1)*100)}% { transform:translate(${k.x}%,${k.y}%); } `);
                        css += `100% { transform:translate(0,0); } }\n`;
                        o.anim = `${n} 2s linear infinite`;
                    }
                    if(o.type==='path') js += `  draw.path(${o.x},${o.y},${o.w},${o.h});\n`;
                    if(o.type==='goal') js += `  draw.goal(${o.x},${o.y},${o.w},${o.h},"${o.next}",${o.holdTime});\n`;
                    if(o.type==='obs') js += `  draw.obstacle(${o.x},${o.y},${o.w},${o.h},"${o.anim}");\n`;
                });
                console.log(css); console.log(js+'}'); alert("Code in Console");
            },
            exportJson() { prompt("Copy:", btoa(JSON.stringify(this.objs))); },
            importJson() { try { this.objs=JSON.parse(atob(prompt("Paste:"))); this.render(); } catch(e){} },
            clear() { if(confirm("Clear?")) { this.objs=[]; this.render(); } },

            togglePlay() {
                this.playing = !this.playing;
                document.body.classList.toggle('play-active', this.playing);
                document.getElementById('play-overlay').style.display = this.playing ? 'block' : 'none';
                this.ui.objL.style.display = this.playing ? 'none' : 'block';
                this.ui.gizL.style.display = this.playing ? 'none' : 'block';
                if(this.playing) Play.start(this.objs); else Play.stop();
            }
        };

        const Keyframes = {
            addPoint(mx, my) {
                const o = Creator.objs.find(x=>x.id===Creator.sel[0]);
                o.kf.push({ x: Math.round((mx-(o.x+o.w/2))/o.w*100), y: Math.round((my-(o.y+o.h/2))/o.h*100) });
                Creator.renderPath(); Creator.updateUI();
            },
            open() { document.getElementById('kf-modal').style.display='flex'; this.render(); },
            render() {
                const o = Creator.objs.find(x=>x.id===Creator.sel[0]);
                const c = document.getElementById('kf-list'); c.innerHTML='';
                o.kf.forEach((k,i) => {
                    c.innerHTML += `<div class="kf-item"><input type="number" value="${k.x}" onchange="Keyframes.set(${i},'x',this.value)"><input type="number" value="${k.y}" onchange="Keyframes.set(${i},'y',this.value)"><button class="danger" onclick="Keyframes.del(${i})">X</button></div>`;
                });
            },
            set(i,k,v) { Creator.objs.find(x=>x.id===Creator.sel[0]).kf[i][k]=parseFloat(v); Creator.renderPath(); },
            del(i) { Creator.objs.find(x=>x.id===Creator.sel[0]).kf.splice(i,1); this.render(); Creator.renderPath(); },
            add() { Creator.objs.find(x=>x.id===Creator.sel[0]).kf.push({x:0,y:0}); this.render(); Creator.renderPath(); },
            save() { 
                const o = Creator.objs.find(x=>x.id===Creator.sel[0]);
                const n = "a"+Math.floor(o.id).toString(36);
                o.anim = `${n} 2s linear infinite`;
                Creator.updateUI();
                document.getElementById('kf-modal').style.display='none';
            }
        };

        const Play = {
            active: false, state: 'wait', mx:0, my:0,
            start(objs) {
                this.active = true; this.state = 'wait';
                const l = document.getElementById('engine-layer'); l.innerHTML='';
                document.getElementById('play-overlay').innerText = "Move to Start...";
                
                // Inject CSS
                let css = "";
                objs.forEach(o => {
                    if(o.kf.length) {
                        const n = o.anim.split(' ')[0];
                        css += `@keyframes ${n} { 0% { transform:translate(0,0); } `;
                        o.kf.forEach((k,i) => css += `${Math.round((i+1)/(o.kf.length+1)*100)}% { transform:translate(${k.x}%,${k.y}%); } `);
                        css += `100% { transform:translate(0,0); } }\n`;
                    }
                });
                document.getElementById('dynamic-css').innerHTML = css;

                // Render Play Objects
                objs.forEach(o => {
                    const e = el('div', `obj v-${o.type}`, `left:${o.x}%;top:${o.y}%;width:${o.w}%;height:${o.h}%;transform:rotate(${o.r}deg)`);
                    if(o.anim) e.style.animation = o.anim;
                    l.appendChild(e);
                    o.el = e; // Cache for collision
                });
                requestAnimationFrame(this.loop.bind(this));
            },
            stop() { this.active = false; document.getElementById('engine-layer').innerHTML=''; },
            loop() {
                if(!this.active) return;
                const r = document.getElementById('game-container').getBoundingClientRect();
                const mx = (this.mx - r.left)/r.width*100, my = (this.my - r.top)/r.height*100;
                
                let safe=false, start=false, dead=false, win=false;

                Creator.objs.forEach(o => {
                    if(!o.el || ['trig','btn'].includes(o.type)) return;
                    const b = o.el.getBoundingClientRect();
                    const bx = (b.left-r.left)/r.width*100, by = (b.top-r.top)/r.height*100;
                    const bw = b.width/r.width*100, bh = b.height/r.height*100;

                    if(mx>=bx && mx<=bx+bw && my>=by && my<=by+bh) {
                        if(o.type==='path' || o.type==='goal') safe=true;
                        if(o.type==='start') { start=true; safe=true; }
                        if(o.type==='goal') win=true;
                        if(o.type==='obs') dead=true;
                    }
                });

                const ov = document.getElementById('play-overlay');
                if(this.state==='wait') {
                    if(start) { this.state='play'; ov.style.display='none'; }
                } else if(this.state==='play') {
                    if(win) { alert("Win!"); this.state='wait'; ov.innerText="Win! Resetting..."; ov.style.display='block'; }
                    else if(dead || !safe) {
                        this.state='dead'; document.body.style.background='#500';
                        setTimeout(()=>{ document.body.style.background='#222'; this.state='wait'; ov.innerText="Died. Move to Start"; ov.style.display='block'; }, 200);
                    }
                }
                requestAnimationFrame(this.loop.bind(this));
            }
        };
        window.onmousemove = e => { Play.mx=e.clientX; Play.my=e.clientY; };
        Creator.init();
    </script>
</body>
</html>