<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Touch Yellow: CO-OP</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Roboto:wght@900&display=swap" rel="stylesheet">
    <style>
        /* --- CO-OP THEME (Purple/Cyan) --- */
        body { margin:0; background:#110011; overflow:hidden; font-family:'Roboto',sans-serif; height:100vh; display:flex; justify-content:center; align-items:center; user-select:none; touch-action:none; -webkit-user-select:none; }
        #game { width:100%; max-width:177.7vh; aspect-ratio:16/9; position:relative; background:#000; box-shadow:0 0 50px #800080; }
        .layer { position:absolute; inset:0; pointer-events:none; }
        #ui { z-index:500; pointer-events:auto; }

        /* LOBBY STYLES */
        .menu-bg { background-color:#2a002a; width:100%; height:100%; position:absolute; top:0; left:0; pointer-events:auto; display:flex; flex-direction:column; align-items:center; justify-content:center; color:cyan; cursor:default; }
        .title { font-family:'Luckiest Guy',cursive; font-size:12vh; color:#d000d0; text-shadow:0.5vh 0.5vh 0 #000; margin-bottom: 2vh; }
        .sub { font-size: 3vh; color: cyan; margin-bottom: 4vh; font-family: monospace; }
        
        .mp-btn { background:#505; border:2px solid #a0a; color:white; font-size:3vh; padding:1.5vh 4vh; cursor:pointer; margin:1vh; font-family:'Luckiest Guy'; transition:0.1s; width: 300px; text-transform:uppercase; }
        .mp-btn:hover { background:#707; transform:scale(1.05); }
        .mp-input { background:#000; border:2px solid #505; color:cyan; font-size:3vh; padding:1vh; text-align:center; width: 300px; font-family:monospace; margin-bottom:1vh; }

        /* GAME OBJECTS */
        .obj { position:absolute; box-shadow: 0 0 0 1px currentColor; transition: transform 0.1s linear; }
        .path { background:#26a9e1; color:#26a9e1; } 
        .goal { background:#f1a92a; color:#f1a92a; } 
        .obs { background:#000; color:transparent; border: 2px dashed #f00; } 
        
        /* Pressure Plates (Purple) */
        .btn { background:#330033; border: 2px solid #d0d; color:#d0d; transition: 0.1s; } 
        .btn.active { background:#d0d; color:#fff; box-shadow: 0 0 20px #d0d; transform: scale(0.95); }
        
        /* Start Zone */
        .start { border: 2px solid cyan; border-radius: 50%; background: rgba(0,255,255,0.1); }

        /* GHOST CURSOR (Partner) */
        #p2-cursor { 
            position:absolute; width:2.5vh; height:2.5vh; 
            background:rgba(0,255,255,0.7); border:2px solid white; border-radius:50%; 
            z-index:450; pointer-events:none; display:none; 
            transition: top 0.05s linear, left 0.05s linear; 
            box-shadow: 0 0 10px cyan;
        }
        
        /* DOOR ANIMATIONS */
        .door-obj { transition: transform 0.2s ease-out, opacity 0.2s; }
        .door-obj.open { transform: scale(0) !important; opacity: 0; pointer-events: none; }
        
        /* START CURTAIN */
        #start-curtain { display:none; position:absolute; top:0; left:0; width:100%; height:100%; background-color:#26a9e1; z-index:9000; cursor:default; pointer-events:auto; }
        #start-trigger { position:absolute; width:10%; height:10%; background:#f1a92a; border-radius:50%; border:2px solid white; box-shadow:0 0 20px white; cursor:pointer; transform:translate(-50%,-50%); animation:pulse 1s infinite alternate; pointer-events:auto; }
        @keyframes pulse { from { transform:translate(-50%,-50%) scale(1); } to { transform:translate(-50%,-50%) scale(1.1); } }

        #id-display { color: yellow; user-select: text; font-family: monospace; cursor: pointer; background:#000; padding:10px; border:1px solid #555; }
        #hud { display:none; position:absolute; top:10px; left:10px; color:cyan; font-family:monospace; font-weight:bold; pointer-events:none; font-size: 2vh; text-shadow: 1px 1px 0 #000; z-index:900; }
        
        @media screen and (orientation: portrait) {
            body { position: fixed; width: 100%; height: 100%; }
            #game { position: absolute; top: 50%; left: 50%; width: 100vh !important; height: 100vw !important; transform: translate(-50%, -50%) rotate(90deg); max-width: none !important; aspect-ratio: auto !important; box-shadow: none !important; }
        }
    </style>
</head>
<body oncontextmenu="return false;" ondragstart="return false;">

    <div id="game">
        <div id="gfx" class="layer" style="z-index:10"></div>
        <div id="phy" class="layer"></div>
        
        <!-- P2 Ghost -->
        <div id="p2-cursor"></div>
        
        <div id="ui" class="layer">
            <!-- LOBBY -->
            <div id="lobby" class="menu-bg">
                <div class="title">CO-OP</div>
                <div class="sub">Requires 2 Players</div>
                
                <div id="lobby-main">
                    <button class="mp-btn" onclick="Net.host()">HOST GAME</button>
                    <br><br>
                    <input id="join-id" class="mp-input" placeholder="Host ID">
                    <br>
                    <button class="mp-btn" onclick="Net.join()">JOIN GAME</button>
                </div>

                <div id="lobby-wait" style="display:none;">
                    <div class="sub">Share this ID:</div>
                    <div id="id-display" onclick="navigator.clipboard.writeText(this.innerText); alert('Copied!')">Generating...</div>
                    <div class="sub" style="margin-top:20px; color:yellow;">Waiting for P2...</div>
                </div>
                
                <button class="mp-btn" style="margin-top:5vh; background:#300; border-color:#500" onclick="location.href='../index.html'">BACK TO MENU</button>
            </div>

            <!-- HUD -->
            <div id="hud">
                STATUS: <span id="conn-stat">CONNECTED</span> | LEVEL: <span id="lvl-stat">1</span>
            </div>
            
            <!-- START CURTAIN -->
            <div id="start-curtain">
                <div id="start-trigger" onmousedown="Engine.activatePhysics()"></div>
            </div>
        </div>
    </div>

<script>
// --- LEVEL DATA (Official Co-op Levels) ---
const LevelData = {
    1: (d) => {
        d.path(10, 40, 80, 20); // Main hallway
        d.start(15, 45, 10, 10); // Start
        
        const btn = d.btn(50, 45, 10, 10);
        btn.tag = "plate1"; btn.link = "door1";
        
        const door = d.obs(70, 40, 5, 20);
        door.tag = "door1"; door.vis.classList.add('door-obj');
        
        d.goal(85, 45, 10, 10, 2);
    },
    2: (d) => {
        d.path(10, 10, 10, 80); // Start shaft
        d.start(10, 50, 10, 10);
        d.path(20, 20, 60, 10); // Top path
        d.path(20, 70, 60, 10); // Bottom path
        d.path(80, 20, 10, 60); // Goal shaft
        
        const b1 = d.btn(50, 20, 8, 8); b1.tag="b1"; b1.link="d1";
        const d1 = d.obs(60, 70, 5, 10); d1.tag="d1"; d1.vis.classList.add('door-obj');
        
        const b2 = d.btn(50, 70, 8, 8); b2.tag="b2"; b2.link="d2";
        const d2 = d.obs(60, 20, 5, 10); d2.tag="d2"; d2.vis.classList.add('door-obj');
        
        d.goal(80, 50, 10, 10, 1); // Loop back to 1 for now
    }
};

// --- NETWORKING ---
const Net = {
    peer: null, conn: null, myId: null,
    host: () => {
        Net.peer = new Peer();
        Net.peer.on('open', id => {
            Net.myId = id;
            document.getElementById('lobby-main').style.display='none';
            document.getElementById('lobby-wait').style.display='block';
            document.getElementById('id-display').innerText = id;
        });
        Net.peer.on('connection', c => { 
            Net.conn = c; 
            Net.setup(); 
            Engine.isHost=true; 
            setTimeout(() => Net.send({type:'start', level:1}), 1000);
        });
    },
    join: () => {
        const id = document.getElementById('join-id').value;
        if(!id) return alert("Enter ID");
        Net.peer = new Peer();
        Net.peer.on('open', () => { Net.conn = Net.peer.connect(id); Net.setup(); });
    },
    setup: () => {
        document.getElementById('lobby').style.display='none';
        document.getElementById('hud').style.display='block';
        
        Net.conn.on('open', () => {
            // Client sends Ready to ensure they get the start command
            if(!Engine.isHost) Net.send({type: 'ready'});
        });

        Net.conn.on('data', d => {
            if(d.type === 'sync') Engine.handleSync(d);
            if(d.type === 'start') Engine.start(d.level);
            if(d.type === 'win') Engine.p2.atGoal = true;
            if(d.type === 'die') Engine.die(); // Shared death
            if(d.type === 'ready' && Engine.isHost) setTimeout(() => Net.send({type:'start', level:1}), 500);
        });
        Engine.init();
    },
    send: (d) => { if(Net.conn && Net.conn.open) Net.conn.send(d); }
};

// --- ENGINE ---
const Engine = {
    active: false, physicsActive: false, mx:0, my:0, isHost: false, currentLevel: 1, hitboxes: [], 
    p2: { x:0, y:0, buttons:[], atGoal: false }, lastSync: 0, cursorX: 0, cursorY: 0,
    els: { gfx:document.getElementById('gfx'), phy:document.getElementById('phy'), p2:document.getElementById('p2-cursor'), curtain:document.getElementById('start-curtain'), trig:document.getElementById('start-trigger') },

    init() {
        const move = (x,y) => { 
            const r = document.getElementById('game').getBoundingClientRect();
            const isPortrait = window.matchMedia("(orientation: portrait)").matches;
            let px, py;
            // Mobile Portrait Fix
            if (isPortrait && /Android|iPhone/i.test(navigator.userAgent)) {
                const relX = x - r.left; const relY = y - r.top;
                const visualX = (relX / r.width) * 100; const visualY = (relY / r.height) * 100;
                px = visualY; py = 100 - visualX;
            } else {
                px = ((x - r.left) / r.width) * 100; py = ((y - r.top) / r.height) * 100;
            }
            Engine.cursorX = px; Engine.cursorY = py;
            Engine.mx = x; Engine.my = y; // Raw for UI if needed
        };
        
        window.addEventListener('mousemove', e => move(e.clientX, e.clientY));
        window.addEventListener('touchmove', e => { e.preventDefault(); move(e.touches[0].clientX, e.touches[0].clientY); }, {passive:false});
        window.addEventListener('contextmenu', e => e.preventDefault());
        this.loop();
    },

    start(id) {
        this.active = true;
        this.physicsActive = false; // Wait for blue screen
        this.currentLevel = id;
        document.getElementById('lvl-stat').innerText = id;
        
        this.hitboxes=[]; this.els.gfx.innerHTML=''; this.els.phy.innerHTML='';
        this.p2.atGoal = false;
        
        const builder = {
            path: (x,y,w,h) => this.spawn(x,y,w,h,'path'),
            obs: (x,y,w,h) => this.spawn(x,y,w,h,'obs'),
            goal: (x,y,w,h,n) => this.spawn(x,y,w,h,'goal',n),
            start: (x,y,w,h) => this.spawn(x,y,w,h,'start'),
            btn: (x,y,w,h) => this.spawn(x,y,w,h,'btn')
        };
        
        if(LevelData[id]) LevelData[id](builder);
        else alert("No Level Data");
        
        // Show Blue Screen Logic
        const startObj = this.hitboxes.find(o => o.type === 'start');
        if(startObj) {
            this.els.curtain.style.display = 'block';
            Object.assign(this.els.trig.style, { 
                left:startObj.hit.style.left, top:startObj.hit.style.top, 
                width:startObj.hit.style.width, height:startObj.hit.style.height 
            });
        }
    },
    
    activatePhysics() {
        this.els.curtain.style.display = 'none';
        this.physicsActive = true;
    },

    spawn(x,y,w,h,type,next) {
        const s = {left:x+'%', top:y+'%', width:w+'%', height:h+'%'};
        const v = document.createElement('div'); v.className=`obj ${type}`; Object.assign(v.style, s);
        if(type==='obs') v.classList.add('door-obj'); // Helper for CSS
        this.els.gfx.appendChild(v);
        const p = document.createElement('div'); p.className=`hitbox`; Object.assign(p.style, s);
        this.els.phy.appendChild(p);
        const obj = { vis:v, hit:p, type, next, tag:"", link:"" };
        this.hitboxes.push(obj);
        return obj;
    },

    loop() {
        requestAnimationFrame(()=>this.loop());
        if(!this.active) return;

        const r = document.getElementById('game').getBoundingClientRect();
        const myPx = this.cursorX;
        const myPy = this.cursorY;

        let myButtons = [];
        let safe = false;
        let atGoal = false;
        
        // Loop through hitboxes
        for(let hb of this.hitboxes) {
            // PHYSICS FIX: Use getBoundingClientRect for Rotated Walls
            const rect = hb.hit.getBoundingClientRect();
            const bx=(rect.left-r.left)/r.width*100;
            const by=(rect.top-r.top)/r.height*100;
            const bw=rect.width/r.width*100;
            const bh=rect.height/r.height*100;
            
            const hit = (myPx>bx && myPx<bx+bw && myPy>by && myPy<by+bh);

            // Button Logic (Pressure Plate)
            if(hb.type === 'btn') {
                if(hit) { safe=true; myButtons.push(hb.tag); }
                const active = hit || Engine.p2.buttons.includes(hb.tag);
                
                if(active) {
                    hb.vis.classList.add('active');
                    if(hb.link) this.toggleDoor(hb.link, true);
                } else {
                    hb.vis.classList.remove('active');
                    if(hb.link) this.toggleDoor(hb.link, false);
                }
            }
            
            if(hit) {
                if(hb.type==='path' || hb.type==='start') safe=true;
                
                // Only kill if physics active (Blue screen gone)
                if(this.physicsActive) {
                    if(hb.type==='obs' && !hb.vis.classList.contains('open')) this.die(); 
                    
                    if(hb.type==='goal') { 
                        safe=true; atGoal=true; 
                        if(this.p2.atGoal && this.isHost) {
                            setTimeout(() => Net.send({type:'start', level:hb.next}), 500);
                            this.start(hb.next);
                        }
                    }
                } else {
                    // Safe while on blue screen
                    safe = true;
                }
            }
        }
        
        if(this.physicsActive && !safe) this.die();

        // Throttled Sync (~15 FPS)
        const now = Date.now();
        if (now - this.lastSync > 66) {
            Net.send({ type:'sync', x: myPx, y: myPy, btns: myButtons, win: atGoal });
            this.lastSync = now;
        }
    },
    
    toggleDoor(tag, open) {
        this.hitboxes.forEach(o => {
            if(o.tag === tag) {
                if(open) o.vis.classList.add('open');
                else o.vis.classList.remove('open');
            }
        });
    },

    handleSync(d) {
        Engine.p2.x = d.x; Engine.p2.y = d.y; Engine.p2.buttons = d.btns || [];
        if(d.win) Engine.p2.atGoal = true; else Engine.p2.atGoal = false;
        
        const r = document.getElementById('game').getBoundingClientRect();
        this.els.p2.style.display = 'block';
        this.els.p2.style.left = (d.x/100 * r.width) + 'px';
        this.els.p2.style.top = (d.y/100 * r.height) + 'px';
    },

    die() {
        this.active = false;
        Net.send({ type:'die' });
        document.body.style.background = "#500";
        setTimeout(() => {
            document.body.style.background = "#110011";
            this.start(this.currentLevel);
        }, 200);
    }
};
</script>
</body>
</html>