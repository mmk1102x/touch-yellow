<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Touch Yellow Web</title>
    <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Roboto:wght@900&display=swap" rel="stylesheet">
    <style>
        body { margin:0; background:#000; overflow:hidden; font-family:'Roboto',sans-serif; height:100vh; display:flex; justify-content:center; align-items:center; user-select:none; touch-action:none; -webkit-user-select:none; }
        #game { width:100%; max-width:177.7vh; aspect-ratio:16/9; position:relative; background:#000; box-shadow:0 0 50px #333; }
        .layer { position:absolute; inset:0; pointer-events:none; }
        #ui { z-index:500; pointer-events:auto; }

        /* MENU STYLES */
        .menu-bg { background-color:#4d4d4d; width:100%; height:100%; position:absolute; top:0; left:0; pointer-events:auto; cursor:default; }
        .grid-line { position:absolute; border:1px dashed rgba(255,255,255,0.3); pointer-events:none; }
        .grid-x { width:100%; height:0; top:50%; left:0; }
        .grid-y { width:0; height:100%; top:0; left:50%; }

        #title-wrapper { position:absolute; top:5%; width:100%; display:flex; justify-content:center; align-items:flex-start; pointer-events:none; z-index:100; line-height:0.85; }
        #t-left { flex:1; text-align:right; padding-right:0.5vh; }
        #t-right { flex:1; text-align:left; padding-left:0.5vh; position:relative; }
        .title-text { font-family:'Luckiest Guy',cursive; font-size:14vh; color:#ffff00; text-transform:uppercase; text-shadow:0.8vh 0.8vh 0 #000; letter-spacing:-0.5vh; display:inline-block; }
        .title-sub { font-family:'Luckiest Guy',cursive; font-size:5vh; color:#ff9900; text-transform:uppercase; text-shadow:0.4vh 0.4vh 0 #000; position:absolute; top:10.5vh; left:14vh; transform:rotate(-3deg); }

        /* BUTTONS */
        .btn-group { position:absolute; display:flex; align-items:center; gap:15px; pointer-events:none; }
        .btn-group:active { transform:scale(0.95); }
        .btn-label { font-family:'Roboto',sans-serif; font-weight:bold; font-size:3.5vh; color:#000; text-shadow: 0 0 2px rgba(255,255,255,0.5); pointer-events:none; user-select:none; }
        .circle-btn { width:8vh; height:8vh; background:#f2a922; border:0.4vh solid #b37a15; border-radius:50%; box-shadow:0 0 10px rgba(0,0,0,0.5); cursor:pointer; pointer-events:auto; transition:transform 0.05s; }
        .circle-btn:active { transform:scale(0.9); }
        
        /* Adjusted Layout (Removed Creator) */
        #grp-saves   { top:22%; right:5%; }
        #grp-custom  { top:38%; right:5%; }
        #grp-mods    { bottom:8%; right:5%; }
        
        #grp-start   { bottom:28%; left:15%; }
        #grp-exit    { bottom:8%; left:15%; }

        #mode-btn { position:absolute; bottom:5%; right:5%; font-family:'Luckiest Guy',cursive; font-size:5vh; color:#ffff00; text-shadow:0.4vh 0.4vh 0 #000; cursor:pointer; user-select:none; z-index:501; transition:transform 0.15s ease-in, color 0.1s; transform-style:preserve-3d; }
        .flip-out { transform:rotateX(90deg); opacity:0.5; }

        /* ACTIVE MOD LIST */
        #active-mods-list { position:absolute; top:10px; left:10px; text-align:left; pointer-events:none; z-index:550; display:flex; flex-direction:column; gap:2px; }
        .active-mod-item { color:#fff; font-family:'Roboto',sans-serif; font-size:1.5vh; font-weight:bold; text-shadow:1px 1px 0 #000; opacity:0.9; }

        /* SAVE SELECT */
        #saves-screen { display:none; position:absolute; top:0; left:0; width:100%; height:100%; background-color:#4d4d4d; z-index:600; cursor:default; }
        .save-title { position:absolute; top:15%; width:100%; text-align:center; font-family:'Luckiest Guy',cursive; font-size:12vh; color:#ffff00; text-shadow:0.6vh 0.6vh 0 #000; pointer-events:none; }
        .save-row { position:absolute; top:45%; width:100%; display:flex; justify-content:center; gap:15vh; }
        .slot-group { display:flex; align-items:center; gap:10px; pointer-events:none; }
        .slot-btn { width:10vh; height:10vh; border-radius:50%; border:0.5vh solid #000; box-shadow:0 0 10px rgba(0,0,0,0.5); pointer-events:auto; transition:transform 0.05s; }
        .slot-btn:active { transform:scale(0.9); }
        .slot-locked { background-color:#444; border-color:#222; cursor:not-allowed; opacity:0.7; }
        .slot-unlocked { background-color:#00ff00; border-color:#004400; cursor:pointer; }
        #btn-back { position:absolute; bottom:10%; left:10%; display:flex; align-items:center; gap:15px; pointer-events:none; }
        .back-circle { width:10vh; height:10vh; background:#fca503; border:0.5vh solid #000; border-radius:50%; cursor:pointer; pointer-events:auto; transition:transform 0.05s; }
        .back-circle:active { transform:scale(0.9); }

        /* MOD MANAGER UI */
        #mod-screen { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; display:none; flex-direction:column; align-items:center; justify-content:center; }
        .mod-window { width:80vh; height:80vh; background-color:#3c2a4d; border:3px solid #1d1226; border-radius:10px; display:flex; flex-direction:column; box-shadow:0 0 50px #000; }
        .mod-header { background:#261a33; padding:15px; border-bottom:2px solid #1d1226; display:flex; justify-content:space-between; align-items:center; }
        .mod-title { font-family:'Luckiest Guy',cursive; font-size:4vh; color:#fff; text-shadow:2px 2px 0 #000; }
        .mod-list-container { flex:1; background:#1d1226; margin:10px; padding:10px; border-radius:8px; overflow-y:auto; }
        .mod-list-container.drag-over { border:2px dashed #0f0; background:rgba(0,255,0,0.1); }
        .mod-item { background:#2a1a38; border:1px solid #000; border-radius:8px; padding:10px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; }
        .mod-info h3 { margin:0; color:#fff; font-family:'Luckiest Guy'; font-size:2.5vh; }
        .mod-info .version { color:#4f4; font-size:1.5vh; margin-left:5px; }
        .mod-info .author { color:#f2a922; font-size:1.5vh; font-family:'Roboto'; display:block; }
        .mod-actions { display:flex; align-items:center; gap:10px; }
        .mod-toggle { width:4vh; height:4vh; background:#111; border:2px solid #555; border-radius:5px; cursor:pointer; display:flex; justify-content:center; align-items:center; }
        .mod-toggle.enabled { background:#0f0; border-color:#040; }
        .mod-toggle.enabled::after { content:"✔"; color:black; font-weight:bold; }
        .mod-btn-small { background:#a33; border:1px solid #f55; color:white; font-weight:bold; cursor:pointer; padding:5px 10px; }
        .mod-btn-gear { background:#444; border:1px solid #888; color:#f2a922; font-weight:bold; cursor:pointer; padding:5px 10px; font-size:1.5vh; }
        .mod-btn-gear:hover { background:#666; }
        .mod-footer { padding:10px; text-align:center; }
        .mp-btn { background:#444; border:2px solid #fff; color:white; font-family:'Luckiest Guy'; font-size:3vh; padding:10px 20px; cursor:pointer; }
        #mod-restart-btn { display:none; background:#f30; color:white; font-family:'Luckiest Guy'; font-size:3vh; text-align:center; padding:15px; cursor:pointer; border-top:3px solid #fff; width:100%; animation:pulse-alert 1s infinite alternate; }
        @keyframes pulse-alert { from { background-color:#f30; transform:scale(1); } to { background-color:#c00; transform:scale(1.02); } }

        /* CONFIG WINDOW */
        #config-overlay { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:2100; display:none; justify-content:center; align-items:center; }
        .config-window { width:60vh; max-height:80vh; background-color:#2a1a38; border:2px solid #f2a922; border-radius:8px; display:flex; flex-direction:column; box-shadow:0 0 50px #000; }
        .config-body { flex:1; overflow-y:auto; padding:15px; }
        #config-table { width:100%; border-collapse:collapse; color:white; font-family:'Roboto',sans-serif; }
        #config-table td { padding:10px; border-bottom:1px solid #444; }
        .cfg-label { font-weight:bold; color:#f2a922; width:50%; }
        .cfg-input { width:100%; background:#111; border:1px solid #555; color:white; padding:5px; font-family:monospace; }
        .cfg-input:focus { border-color:#f2a922; outline:none; }

        /* GAME OBJECTS */
        .obj { position:absolute; box-shadow: 0 0 0 1px currentColor; }
        .path { background:#26a9e1; color:#26a9e1; } .goal { background:#f1a92a; color:#f1a92a; } 
        .obs { background:#000; color:transparent; } 
        .btn { background:#33cc33; color:#33cc33; } .btn.on { background:#228822; color:#228822; }
        .paused { animation-play-state: paused !important; }
        
        /* DEBUG VISUALS */
        .hitbox { position:absolute; z-index:400; opacity:0; pointer-events:none; }
        .debug .hitbox { opacity:1 !important; }
        .debug .hitbox.path { background:transparent; border:none; }
        .debug .hitbox.goal { background:rgba(0,255,0,0.5); border:2px solid lime; }
        .debug .hitbox.obs { background:rgba(255,0,0,0.5); border:2px solid red; background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.5) 10px, rgba(0,0,0,0.5) 20px); }
        .debug .hitbox.trig, .debug .hitbox.btn { background:rgba(148,0,211,0.5); border:2px dashed magenta; }
        .debug .hitbox.start { background:rgba(0,255,0,0.1); border:1px dotted lime; }

        /* DEBUG OVERLAY */
        .debug-overlay { display:none; pointer-events:none; position:absolute; top:0; left:0; width:100%; height:100%; z-index:9999; }
        .debug .debug-overlay { display:block; }
        #db-cross-x { position:absolute; width:100%; height:1px; background-color:cyan; left:0; }
        #db-cross-y { position:absolute; width:1px; height:100%; background-color:cyan; top:0; }
        #db-coords { position:absolute; bottom:5px; right:5px; color:cyan; font-family:monospace; font-size:2vh; font-weight:bold; background:rgba(0,0,0,0.8); padding:2px 5px; border:1px solid cyan; }
        #db-room { position:absolute; bottom:5px; left:5px; color:cyan; font-family:monospace; font-size:2vh; font-weight:bold; background:rgba(0,0,0,0.8); padding:2px 5px; border:1px solid cyan; }
        
        #cheat-ind { position:absolute; top:10px; left:10px; color:yellow; font-weight:bold; display:none; z-index:999; font-family:monospace; font-size:2vh; text-shadow:1px 1px 0 #000; }
        #debug-ind { position:absolute; top:35px; left:10px; color:lime; font-weight:bold; display:none; z-index:999; font-family:monospace; font-size:2vh; text-shadow:1px 1px 0 #000; }
        #catch-meter { position:fixed; display:none; width:40px; height:6px; background:#333; border:1px solid white; border-radius:3px; pointer-events:none; z-index:9999; transform:translate(-50%,-20px); }
        #catch-fill { width:0%; height:100%; background:#00ff00; transition:width 0.05s linear; }
        #dynamic-css { display:none; }
        
        /* START CURTAIN */
        #start-curtain { display:none; position:absolute; top:0; left:0; width:100%; height:100%; background-color:#26a9e1; z-index:9000; cursor:default; pointer-events:auto; }
        #start-trigger { position:absolute; width:10%; height:10%; background:#f1a92a; border-radius:50%; border:2px solid white; box-shadow:0 0 20px white; cursor:pointer; transform:translate(-50%,-50%); animation:pulse 1s infinite alternate; pointer-events:auto; }
        @keyframes pulse { from { transform:translate(-50%,-50%) scale(1); } to { transform:translate(-50%,-50%) scale(1.1); } }

        @keyframes slicerMove { 0% { transform: translateY(0%); } 50% { transform: translateY(200%); } 100% { transform: translateY(0%); } }
        @keyframes waterfallDrop { 0% { transform: translateY(-250%); } 100% { transform: translateY(250%); } }
        @keyframes crazyMove { 0% { transform: translate(0, 0); } 20% { transform: translate(250%, -350%); } 40% { transform: translate(250%, 0%); } 60% { transform: translate(120%, -150%); } 80% { transform: translate(0, -350%); } 100% { transform: translate(0, 0); } }
        @keyframes safeRoomPatrol { 0% {transform:translate(0,0)} 25%{transform:translate(1000%,-20%)} 50%{transform:translate(500%,20%)} 75%{transform:translate(1000%,20%)} 90%{transform:translate(500%,-20%)} 100%{transform:translate(0,0)} }
        @keyframes superCrazyMove { 0% { transform: translate(0,0); } 10% { transform: translate(800%, 200%); } 20% { transform: translate(200%, 400%); } 30% { transform: translate(600%, 0%); } 40% { transform: translate(0%, 300%); } 50% { transform: translate(900%, 300%); } 60% { transform: translate(400%, 100%); } 70% { transform: translate(100%, 0%); } 80% { transform: translate(700%, 400%); } 90% { transform: translate(300%, 100%); } 100% { transform: translate(0,0); } }

        /* MOBILE */
        @media screen and (orientation: portrait) {
            body { position: fixed; width: 100%; height: 100%; }
            #game {
                position: absolute; top: 50%; left: 50%;
                width: 100vh !important; height: 100vw !important;
                transform: translate(-50%, -50%) rotate(90deg);
                max-width: none !important; aspect-ratio: auto !important; box-shadow: none !important;
            }
            .circle-btn { width: 8vw !important; height: 8vw !important; border-width: 0.5vw !important; }
            .btn-label { font-size: 3.5vw !important; text-shadow: none !important; }
            .title-text { font-size: 14vw !important; }
            .title-sub { font-size: 5vw !important; top: 10.5vw !important; left: 14vw !important; }
            .slot-btn, .back-circle { width: 10vw !important; height: 10vw !important; }
            #mode-btn { display: none !important; }
        }
    </style>
    <style id="dynamic-css"></style>
</head>
<body oncontextmenu="return false;" ondragstart="return false;">
    <div id="catch-meter"><div id="catch-fill"></div></div>
    
    <div id="game">
        <div class="debug-overlay">
            <div id="db-cross-x"></div><div id="db-cross-y"></div>
            <div id="db-coords">X: 0.00% Y: 0.00%</div><div id="db-room">ROOM: MENU</div>
        </div>

        <div id="gfx" class="layer" style="z-index:10"></div>
        <div id="phy" class="layer"></div>
        <div id="ui" class="layer">
            
            <div id="menu" class="menu-bg">
                <div class="grid-line grid-x"></div><div class="grid-line grid-y"></div>
                <div id="title-wrapper">
                    <div id="t-left"><span class="title-text">Touch</span></div>
                    <div id="t-right"><span class="title-text">Yellow</span><div class="title-sub">Web</div></div>
                </div>
                
                <!-- ACTIVE MOD LIST -->
                <div id="active-mods-list"></div>

                <div id="grp-saves" class="btn-group">
                    <span class="btn-label">Saves -&gt;</span>
                    <div class="circle-btn" onmousedown="window.Engine.openSavesMenu()"></div>
                </div>
                
                <div id="grp-custom" class="btn-group">
                    <span class="btn-label">Custom -&gt;</span>
                    <div class="circle-btn" style="background:#b0f; border-color:#80c;" onmousedown="window.Engine.loadCustom()"></div>
                </div>

                <div id="grp-mods" class="btn-group">
                    <span class="btn-label">Mods -&gt;</span>
                    <div class="circle-btn" style="background:#800080; border-color:#500050;" onmousedown="ModUI.open()"></div>
                </div>
                
                <div id="grp-start" class="btn-group">
                    <div class="circle-btn" onmousedown="window.Engine.start(1)"></div>
                    <span class="btn-label">&lt;- Start/Restart</span>
                </div>
                
                <div id="grp-exit" class="btn-group">
                    <div class="circle-btn" onmousedown="if(document.fullscreenElement) document.exitFullscreen(); window.Engine.toMenu();"></div>
                    <span class="btn-label">&lt;- Exit</span>
                </div>
                
                <div id="mode-btn" onmousedown="window.Engine.toggleMode()">HOVER MODE</div>
            </div>

            <div id="saves-screen">
                <div class="save-title">SELECT SAVE</div>
                <div class="save-row">
                    <div id="slot-1" class="slot-group">
                        <div id="circle-1" class="slot-btn slot-locked" onmousedown="window.Engine.loadSave(1)"></div>
                        <span class="btn-label">&lt;- Save 1</span>
                    </div>
                    <div id="slot-2" class="slot-group">
                        <div id="circle-2" class="slot-btn slot-locked" onmousedown="window.Engine.loadSave(2)"></div>
                        <span class="btn-label">&lt;- Save 2</span>
                    </div>
                </div>
                <div id="btn-back">
                    <div class="back-circle" onmousedown="window.Engine.closeSaves()"></div>
                    <span class="btn-label">&lt;- Back</span>
                </div>
            </div>
            
            <!-- MOD MANAGER UI -->
            <div id="mod-screen" style="display:none;">
                <div class="mod-window">
                    <div class="mod-header">
                        <span class="mod-title">MODS</span>
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="mod-search" placeholder="Search..." onkeyup="ModUI.filter()" style="padding:5px; font-family:'Roboto'; border-radius:4px; border:none;">
                            <button class="mod-btn-small" onclick="ModUI.close()">X</button>
                        </div>
                    </div>
                    <div id="mod-list" class="mod-list-container"></div>
                    <div id="mod-restart-btn" onclick="location.reload()">⚠ RESTART REQUIRED TO APPLY ⚠</div>
                    <div class="mod-footer">
                        <button class="mp-btn" onclick="ModUI.importFile()">+ IMPORT .ADDON</button>
                    </div>
                </div>
            </div>

            <!-- CONFIG EDITOR OVERLAY -->
            <div id="config-overlay" style="display:none;">
                <div class="config-window">
                    <div class="mod-header">
                        <span class="mod-title" id="cfg-title">SETTINGS</span>
                        <button class="mod-btn-small" onclick="ModUI.closeConfig()">X</button>
                    </div>
                    <div class="config-body">
                        <table id="config-table"></table>
                    </div>
                    <div class="mod-footer">
                        <button class="mp-btn" onclick="ModUI.saveConfig()">SAVE & RELOAD</button>
                    </div>
                </div>
            </div>

            <div id="start-curtain">
                <div id="start-trigger" onmousedown="window.Engine.activateCustom()"></div>
            </div>

            <div id="cheat-ind">NOCLIP ON</div>
            <div id="debug-ind">HITBOXES ON</div>
        </div>
    </div>

<script>
// --- MOD LOADER (Async IndexedDB) ---
const ModDB={db:null,open:()=>new Promise((r,j)=>{const q=indexedDB.open("TouchYellowMods",2);q.onupgradeneeded=e=>{if(!e.target.result.objectStoreNames.contains('mods'))e.target.result.createObjectStore('mods',{keyPath:'id'});};q.onsuccess=e=>{ModDB.db=e.target.result;r();};q.onerror=e=>j(e);}),save:m=>new Promise((r,j)=>{const t=ModDB.db.transaction(['mods'],'readwrite');t.objectStore('mods').put(m);t.oncomplete=()=>r();t.onerror=()=>j(t.error);}),getAll:()=>new Promise(r=>{if(!ModDB.db)return r([]);const t=ModDB.db.transaction(['mods'],'readonly');const q=t.objectStore('mods').getAll();q.onsuccess=()=>r(q.result);}),delete:id=>{ModDB.db.transaction(['mods'],'readwrite').objectStore('mods').delete(id);}};
const ModLoader={mods:[],init:async(cb)=>{console.log("[System] Booting ModLoader...");try{await ModDB.open();ModLoader.mods=await ModDB.getAll();
    const list = document.getElementById('active-mods-list');
    ModLoader.mods.forEach(m=>{if(m.enabled){try{
        const settings={}; if(m.configSchema){for(let k in m.configSchema){const s=m.userConfig?m.userConfig[k]:undefined;settings[k]=(s!==undefined)?s:m.configSchema[k].default;}}
        const f=new Function('ModAPI','Engine','Net','Settings',m.code);f(window.ModAPI,(window.Engine||{}),(window.Net||{}),settings);console.log(`[Mod] Loaded: ${m.name}`);
        if(list) list.innerHTML += `<div class="active-mod-item">${m.name} v${m.version}</div>`;
    }catch(e){console.error(e);}}});}catch(e){console.error(e);}if(cb)cb();},install:async(d)=>{if(!d.name||!d.code)return alert("Invalid Mod");d.id=Date.now().toString();d.enabled=true;await ModDB.save(d);ModLoader.mods.push(d);ModUI.render();ModUI.triggerRestart();},delete:async(id)=>{if(confirm("Delete?")){ModLoader.mods=ModLoader.mods.filter(m=>m.id!==id);await ModDB.delete(id);ModUI.render();ModUI.triggerRestart();}},toggle:async(id)=>{const m=ModLoader.mods.find(x=>x.id===id);if(m){m.enabled=!m.enabled;await ModDB.save(m);ModUI.render();ModUI.triggerRestart();}}};
window.ModAPI={hook:(t,f)=>{const p=t.split('.');const o=window[p[0]];if(o&&o[p[1]]){const org=o[p[1]].bind(o);o[p[1]]=(...a)=>f(org,...a);}}};

// --- MOD UI ---
const ModUI={
    currentModId:null,
    open:()=>{document.getElementById('mod-screen').style.display='flex';ModUI.render();setTimeout(ModUI.initDrag,100);},
    close:()=>document.getElementById('mod-screen').style.display='none',
    render:()=>{
        const l=document.getElementById('mod-list'); l.innerHTML='';
        const f=document.getElementById('mod-search').value.toLowerCase();
        if(!ModLoader.mods.length){l.innerHTML='<div style="text-align:center;color:#888;margin-top:50px">No Mods Installed.<br>Drag & Drop .addon file here.</div>';return;}
        ModLoader.mods.forEach(m=>{
            if(!m.name.toLowerCase().includes(f))return;
            const hasCfg = m.configSchema && Object.keys(m.configSchema).length>0;
            const gear = hasCfg ? `<button class="mod-btn-gear" onclick="ModUI.openConfig('${m.id}')">⚙️</button>` : '';
            const d=document.createElement('div'); d.className='mod-item';
            d.innerHTML=`<div class="mod-info"><h3>${m.name} <span class="version">v${m.version}</span></h3><span class="author">by ${m.author}</span></div><div class="mod-actions">${gear}<button class="mod-btn-small" onclick="ModLoader.delete('${m.id}')">DEL</button><div class="mod-toggle ${m.enabled?'enabled':''}" onclick="ModLoader.toggle('${m.id}')"></div></div>`;
            l.appendChild(d);
        });
    },
    openConfig:(id)=>{
        ModUI.currentModId=id; const m=ModLoader.mods.find(x=>x.id===id); if(!m||!m.configSchema)return;
        document.getElementById('cfg-title').innerText=m.name+" Settings"; const t=document.getElementById('config-table'); t.innerHTML="";
        for(let k in m.configSchema){
            const def=m.configSchema[k]; const val=(m.userConfig&&m.userConfig[k]!==undefined)?m.userConfig[k]:def.default;
            const tr=document.createElement('tr'); const tdL=document.createElement('td'); tdL.className="cfg-label"; tdL.innerText=def.name||k;
            const tdI=document.createElement('td'); let inp;
            if(def.type==='boolean'){inp=document.createElement('input'); inp.type='checkbox'; inp.checked=val; inp.id=`cfg-${k}`;}
            else if(def.type==='key'){inp=document.createElement('input'); inp.type='text'; inp.className='cfg-input'; inp.value=val; inp.readOnly=true; inp.id=`cfg-${k}`; inp.style.cursor="pointer"; inp.style.textAlign="center"; inp.onkeydown=e=>{e.preventDefault();inp.value=e.key.toUpperCase();inp.blur();};}
            else{inp=document.createElement('input'); inp.type=def.type||'text'; inp.className='cfg-input'; inp.value=val; inp.id=`cfg-${k}`;}
            tdI.appendChild(inp); tr.append(tdL,tdI); t.appendChild(tr);
        }
        document.getElementById('config-overlay').style.display='flex';
    },
    saveConfig:async()=>{
        const id=ModUI.currentModId; const m=ModLoader.mods.find(x=>x.id===id); if(!m)return;
        if(!m.userConfig)m.userConfig={};
        for(let k in m.configSchema){
            const el=document.getElementById(`cfg-${k}`); const def=m.configSchema[k];
            if(def.type==='boolean') m.userConfig[k]=el.checked; else if(def.type==='number') m.userConfig[k]=parseFloat(el.value); else m.userConfig[k]=el.value;
        }
        await ModDB.save(m); location.reload();
    },
    closeConfig:()=>{document.getElementById('config-overlay').style.display='none';},
    triggerRestart:()=>{document.getElementById('mod-restart-btn').style.display='block';},
    importFile:()=>{
        const i=document.createElement('input'); i.type='file'; i.accept='.addon,.json';
        i.onchange=e=>{const f=e.target.files[0]; if(!f)return; if(f.size>1e8)return alert("Too big"); const r=new FileReader(); r.onload=ev=>{try{const d=JSON.parse(ev.target.result); if(!d.name||!d.code)throw 0; ModLoader.install(d);}catch(e){alert("Invalid Mod");}}; r.readAsText(f);};
        i.click();
    },
    initDrag:()=>{
        const z=document.getElementById('mod-list');
        ['dragenter','dragover'].forEach(e=>z.addEventListener(e,ev=>{ev.preventDefault();z.classList.add('drag-over');}));
        z.addEventListener('dragleave',e=>{e.preventDefault();z.classList.remove('drag-over');});
        z.addEventListener('drop',e=>{e.preventDefault();z.classList.remove('drag-over'); if(e.dataTransfer.files[0])ModUI.processFile(e.dataTransfer.files[0]);});
    },
    processFile:(f)=>{
        if(!f.name.endsWith('.addon')&&!f.name.endsWith('.json'))return alert("Invalid type");
        const r=new FileReader(); r.onload=e=>{try{const d=JSON.parse(e.target.result); if(!d.name)throw 0; ModLoader.install(d);}catch(e){alert("Invalid");}}; r.readAsText(f);
    },
    filter:()=>ModUI.render()
};

let GlobalLevels = {};

window.Engine = {
    active: false, state: 'menu', mx:0, my:0, mobile:false, holding:false, holdMode:false, hitboxes:[], noclip: false, goalTimer:0, linkPlay: false, cursorX:0, cursorY:0,
    els: {},

    async init() {
        this.els = { gfx:document.getElementById('gfx'), phy:document.getElementById('phy'), menu:document.getElementById('menu'), hud:document.getElementById('catch-meter'), fill:document.getElementById('catch-fill'), css:document.getElementById('dynamic-css'), curtain:document.getElementById('start-curtain'), trig:document.getElementById('start-trigger') };

        try {
            const response = await fetch('levels.json');
            if(!response.ok) throw new Error("File not found");
            GlobalLevels = await response.json();
        } catch (e) { console.error("Levels missing (Local/CORS)"); }

        const urlParams = new URLSearchParams(window.location.search);
        if(urlParams.has('data')) {
            try {
                localStorage.setItem('ty_custom_level_data', JSON.stringify(JSON.parse(atob(urlParams.get('data')))));
                this.linkPlay = true; this.els.menu.style.display = 'none';
                setTimeout(() => this.start('custom'), 50);
            } catch(e) { alert("Corrupt Link"); }
        }

        this.mobile = 'ontouchstart' in window;
        const savedHold = localStorage.getItem('touchYellow_holdMode') === 'true';
        if(this.mobile) {
            this.holdMode=true; 
            const mb = document.getElementById('mode-btn'); if(mb) mb.style.display='none';
        } else if(savedHold) {
            this.holdMode=true;
            const mb = document.getElementById('mode-btn'); 
            if(mb) { mb.innerText="HOLD MODE"; mb.style.color="#f2a922"; }
        }

        const move = (x,y) => { 
            this.mx=x; this.my=y; 
            const cx = document.getElementById('db-cross-x');
            const cy = document.getElementById('db-cross-y');
            const ct = document.getElementById('db-coords');
            if(cx && cy) { 
                const r = document.getElementById('game').getBoundingClientRect();
                const ly = y - r.top; const lx = x - r.left;
                cx.style.top = ly + 'px'; cy.style.left = lx + 'px';
                if(ct) ct.innerText = `X: ${(lx/r.width*100).toFixed(2)}% Y: ${(ly/r.height*100).toFixed(2)}%`;
            }
        };
        window.addEventListener('mousemove', e => move(e.clientX, e.clientY));
        window.addEventListener('touchmove', e => { e.preventDefault(); move(e.touches[0].clientX, e.touches[0].clientY); }, {passive:false});
        
        const down = () => this.holding=true;
        const up = () => { this.holding=false; if(this.state==='playing' && this.holdMode) this.die(); };
        window.addEventListener('mousedown', down); window.addEventListener('touchstart', down);
        window.addEventListener('mouseup', up); window.addEventListener('touchend', up);
        window.addEventListener('touchcancel', up);
        window.addEventListener('mousedown', e => { if(e.button===2 && this.active && !this.noclip) this.die(); });

        if(localStorage.getItem('touchYellow_noclip')==='true'){ this.noclip=true; document.getElementById('cheat-ind').style.display='block'; }
        if(localStorage.getItem('touchYellow_debug')==='true'){ document.getElementById('game').classList.add('debug'); document.getElementById('debug-ind').style.display='block'; }
        
        this.loop();
    },

    toggleMode() {
        const btn = document.getElementById('mode-btn'); if(!btn) return;
        btn.classList.add('flip-out');
        setTimeout(() => {
            this.holdMode = !this.holdMode;
            localStorage.setItem('touchYellow_holdMode', this.holdMode);
            if(this.holdMode) { btn.innerText="HOLD MODE"; btn.style.color="#f2a922"; }
            else { btn.innerText="HOVER MODE"; btn.style.color="#ffff00"; }
            btn.classList.remove('flip-out');
        }, 150);
    },

    start(id) {
        if(id === "redirect_save1") { localStorage.setItem('touchYellow_save1','true'); location.href='save/save1.html'; return; }
        if (!document.fullscreenElement) { document.documentElement.requestFullscreen().catch(e=>{}); }
        this.reset();
        this.active = true;
        this.els.menu.style.display='none'; document.getElementById('saves-screen').style.display='none';
        
        this.state = (id==='custom') ? 'waiting' : 'playing'; 
        document.getElementById('db-room').innerText = (id==='custom') ? "ROOM: CUSTOM" : "ROOM: LEVEL " + id;
        
        const builder = {
            path: (x,y,w,h) => this.spawn(x,y,w,h,'path'),
            obs: (x,y,w,h,a) => this.spawn(x,y,w,h,'obs',a),
            goal: (x,y,w,h,n,t) => this.spawn(x,y,w,h,'goal',null,n,t),
            trig: (x,y,w,h) => this.spawn(x,y,w,h,'trig')
        };

        if(id === 'custom') this.loadCustom(builder);
        else if(GlobalLevels[id]) {
            if(GlobalLevels[id].world !== 1) { alert("Wrong World"); location.href='save/save1.html'; return; }
            this.buildLevel(GlobalLevels[id].objects);
        } else { 
            alert("You Win!"); this.toMenu(); 
        }
    },

    buildLevel(objects) {
        this.els.css.innerHTML = "";
        objects.forEach(o => {
            let animName = o.anim;
            if (o.kfs && o.kfs.length > 0) {
                const nm = `anim-${Math.random().toString(36).substr(2,5)}`;
                let css = `@keyframes ${nm} { 0% { transform: translate(0,0) rotate(${o.r || 0}deg); } `;
                o.kfs.forEach((k, i) => { 
                    const pct = Math.round((i + 1) / (o.kfs.length + 1) * 100); 
                    const kx = (Array.isArray(k) ? k[0] : k.x)||0;
                    const ky = (Array.isArray(k) ? k[1] : k.y)||0;
                    css += `${pct}% { transform: translate(${kx}%, ${ky}%) rotate(${o.r || 0}deg); } `; 
                });
                css += `100% { transform: translate(0,0) rotate(${o.r || 0}deg); } } `;
                this.els.css.innerHTML += css;
                animName = `${nm} ${o.dur || 2}s linear ${o.loop !== false ? 'infinite' : 'forwards'}`;
            }

            const obj = this.spawn(o.x, o.y, o.w, o.h, o.type, animName, o.next, o.hold);
            if(o.tag) { obj.tag = o.tag; obj.vis.id = "run-" + o.tag; }
            if(o.link) obj.link = o.link;
            if(o.wait) { obj.vis.classList.add('paused'); obj.hit.classList.add('paused'); }
            if(o.z) obj.vis.style.zIndex = o.z;
            if(o.r) {
                obj.vis.style.transform = `rotate(${o.r}deg)`;
                obj.hit.style.transform = `rotate(${o.r}deg)`;
            }
        });
    },

    loadCustom(builder) {
        const raw = localStorage.getItem('ty_custom_level_data');
        if (!raw) { alert("No custom level data."); this.toMenu(); return; }
        try { this.parseCookie(raw, builder); } catch(e) { alert("Level Corrupt"); this.toMenu(); }
        
        const startObj = this.hitboxes.find(o => o.type === 'start');
        if(startObj) {
            this.els.curtain.style.display = 'block';
            // Fix: Center the trigger
            const s = startObj.hit.style;
            const sx=parseFloat(s.left), sy=parseFloat(s.top), sw=parseFloat(s.width), sh=parseFloat(s.height);
            Object.assign(this.els.trig.style, { 
                left: (sx + sw/2) + '%', 
                top: (sy + sh/2) + '%', 
                width: sw + '%', 
                height: sh + '%' 
            });
        } else { alert("Level has no Start!"); this.toMenu(); }
    },
    
    activateCustom() { this.els.curtain.style.display = 'none'; this.state = 'playing'; },

    parseCookie(jsonStr, d) {
        const data = JSON.parse(jsonStr);
        let css = "";
        data.forEach(o => {
            const types = ['path','obs','goal','start','btn','trig'];
            const t = types[o[0]];
            let anim = null;
            if(o[5] && o[5].length) {
                const nm = `a-${Math.random().toString(36).substr(2)}`;
                css += `@keyframes ${nm} { 0%{transform:translate(0,0)} `;
                o[5].forEach((k,i) => css += `${Math.round((i+1)/(o[5].length+1)*100)}%{transform:translate(${k[0]}%,${k[1]}%)} `);
                css += `100%{transform:translate(0,0)} } `;
                anim = `${nm} ${o[9]||2}s linear infinite`;
            }
            const type = (t==='start') ? 'start' : t;
            const obj = this.spawn(o[1], o[2], o[3], o[4], type, anim, (t==='goal'?'menu':null));
            if(o[6]) obj.tag = o[6]; if(o[7]) obj.link = o[7];
            if(o[8]) { obj.vis.classList.add('paused'); obj.hit.classList.add('paused'); }
            if(o[10]) obj.vis.style.zIndex = o[10];
        });
        this.els.css.innerHTML += css;
    },

    spawn(x,y,w,h,type,anim,next,holdTime) {
        const s = {left:x+'%', top:y+'%', width:w+'%', height:h+'%'};
        const v = document.createElement('div'); v.className=`obj ${type}`; Object.assign(v.style, s);
        if(anim) v.style.animation = anim;
        this.els.gfx.appendChild(v);
        const p = document.createElement('div'); p.className=`hitbox ${type}`; Object.assign(p.style, s);
        if(anim) p.style.animation = anim;
        this.els.phy.appendChild(p);
        const obj = { vis:v, hit:p, type, next, tag:"", link:"", hold:holdTime||0, style:s };
        this.hitboxes.push(obj);
        return obj;
    },

    loop() {
        requestAnimationFrame(()=>this.loop());
        if(!this.active) return;
        const r = document.getElementById('game').getBoundingClientRect();
        const mx = this.cursorX;
        const my = this.cursorY;
        
        if((mx<0||mx>100||my<0||my>100) && this.state==='playing') return this.die();
        if(this.holdMode && !this.holding) return;
        let safe = false; let touchingGoal = false;
        
        for(let hb of this.hitboxes) {
            const hr = hb.hit.getBoundingClientRect();
            const bx=(hr.left-r.left)/r.width*100, by=(hr.top-r.top)/r.height*100;
            const bw=hr.width/r.width*100, bh=hr.height/r.height*100;

            if(mx>bx && mx<bx+bw && my>by && my<by+bh) {
                if(hb.type === 'obs' && this.state==='playing') return this.die();
                
                if(hb.type === 'path') safe = true;
                
                // Ghost Mode Logic
                if(hb.type === 'start') { 
                    safe = true; 
                    if(this.state === 'waiting') { 
                        this.state = 'playing'; 
                        console.log("Game Active");
                    } 
                }
                
                if(hb.type === 'goal') { 
                    safe=true; touchingGoal=true; 
                    if(hb.hold > 0) {
                        this.goalTimer += 16;
                        this.els.hud.style.display='block';
                        this.els.hud.style.left = this.cursorX+'%'; 
                        this.els.hud.style.top = (this.cursorY-5)+'%';
                        this.els.fill.style.width = (this.goalTimer/hb.hold*100)+'%';
                        if(this.goalTimer >= hb.hold) this.win(hb.next);
                    } else { this.win(hb.next); }
                }
                
                if((hb.type==='btn' || hb.type==='trig') && hb.link) {
                    safe=true;
                    this.hitboxes.forEach(t => { if(t.tag === hb.link) { t.vis.classList.remove('paused'); t.hit.classList.remove('paused'); }});
                    if(hb.type==='btn') hb.vis.classList.add('on');
                }
            }
        }
        
        document.getElementById('game').style.cursor = (this.state==='playing' && safe) ? 'crosshair' : 'default';
        if(!touchingGoal) { this.goalTimer=0; this.els.hud.style.display='none'; }
        if(this.state === 'playing' && !safe) this.die();
    },

    win(next) { if(next==='menu') { alert("Complete!"); if(this.linkPlay) this.start('custom'); else this.toMenu(); } else this.start(next); },
    die() { if(this.noclip) return; this.active = false; if(this.linkPlay) this.start('custom'); else this.toMenu(); },
    reset() { 
        this.active=false; this.hitboxes=[]; 
        this.els.gfx.innerHTML=''; this.els.phy.innerHTML=''; 
        document.getElementById('game').style.cursor='default';
        this.els.curtain.style.display = 'none';
        
        // Hide Active Mod List when playing
        const ml = document.getElementById('active-mods-list');
        if(ml) ml.style.display = 'none';
    },
    toMenu() { 
        this.reset(); 
        this.els.menu.style.display='block'; 
        document.getElementById('db-room').innerText="ROOM: MENU"; 
        
        // Show Active Mod List in Menu
        const ml = document.getElementById('active-mods-list');
        if(ml) ml.style.display = 'flex';
    },
    
    openSavesMenu() { document.getElementById('saves-screen').style.display='block'; document.getElementById('menu').style.display='none'; this.checkSave(1); this.checkSave(2); },
    closeSaves() { document.getElementById('saves-screen').style.display='none'; document.getElementById('menu').style.display='block'; },
    checkSave(n) { const has = localStorage.getItem(`touchYellow_save${n}`) === 'true'; document.getElementById(`circle-${n}`).className = `slot-btn slot-${has?'unlocked':'locked'}`; },
    loadSave(n) { if(localStorage.getItem(`touchYellow_save${n}`) === 'true') location.href=`save/save${n}.html`; else alert("Locked!"); }
};

// BOOTSTRAP
ModLoader.init(() => {
    console.log("[System] Starting Engine...");
    window.Engine.init();
});

// --- COMMANDS ---
Object.defineProperties(window, {
    'debug': { get: function() { const g=document.getElementById('game'); g.classList.toggle('debug'); const on=g.classList.contains('debug'); document.getElementById('debug-ind').style.display=on?'block':'none'; localStorage.setItem('touchYellow_debug', on); return `Debug: ${on?"ON":"OFF"}`; } },
    'noclip': { get: function() { window.Engine.noclip=!window.Engine.noclip; document.getElementById('cheat-ind').style.display=window.Engine.noclip?'block':'none'; localStorage.setItem('touchYellow_noclip', window.Engine.noclip); return `God Mode: ${window.Engine.noclip?"ON":"OFF"}`; } },
    'clear': { get: function() { localStorage.clear(); alert("Wiped"); window.location.href='index.html'; return "Resetting..."; } }
});
window.s1='save1'; window.s2='save2'; window.menu='menu';
window.load = function(t) {
    if(typeof t==='number') { window.Engine.start(t); return `Level ${t}`; }
    const s=String(t).toLowerCase();
    if(s==='menu') { window.Engine.toMenu(); return "Menu"; }
    if(s==='save'||s==='saves') { window.Engine.openSavesMenu(); return "Saves"; }
    if(s==='save1'||s==='s1') { localStorage.setItem('touchYellow_save1','true'); location.href='save/save1.html'; return "World 2"; }
    if(s==='save2'||s==='s2') { localStorage.setItem('touchYellow_save2','true'); alert("Unlocked 2"); window.Engine.openSavesMenu(); return "Unlock"; }
};

// --- EMERGENCY MOD TOOLS ---
window.listMods = () => {
    if (ModLoader.mods.length === 0) return console.log("No mods installed.");
    console.table(ModLoader.mods.map(m => ({ Name: m.name, Version: m.version, Enabled: m.enabled, ID: m.id })));
};
window.deleteMod = async (name) => {
    if (!name) return console.warn("Usage: deleteMod('Mod Name')");
    const target = ModLoader.mods.find(m => m.name.toLowerCase() === name.toLowerCase());
    if (target) {
        console.log(`%c[System] Deleting "${target.name}"...`, "color: orange");
        await ModDB.delete(target.id);
        console.log(`%c[System] Success! Reloading game...`, "color: lime");
        setTimeout(() => location.reload(), 500);
    } else {
        console.error(`Mod "${name}" not found.`);
        console.log("Type listMods() to see installed mods.");
    }
};
</script>
</body>
</html>