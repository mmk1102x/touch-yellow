<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Touch Yellow - World 2</title>
    <style>
        body { margin:0; background:#000; overflow:hidden; font-family:'Roboto',sans-serif; height:100vh; display:flex; justify-content:center; align-items:center; user-select:none; touch-action:none; }
        #game { width:100%; max-width:177.7vh; aspect-ratio:16/9; position:relative; background:#000; box-shadow:0 0 50px #00b0f0; }
        .layer { position:absolute; inset:0; pointer-events:none; }
        #ui { z-index:50; pointer-events:auto; text-align:center; display:flex; flex-direction:column; justify-content:center; background:#00b0f0; }
        /* OBJECTS */
        .obj { position:absolute; transition:background 0.3s; }
        .path { background:#26a9e1; } .goal { background:#f1a92a; } .obs { background:#000; } 
        .btn { background:#33cc33; border:1px solid #fff; } .btn.on { background:#228822; }
        /* DEBUG */
        .hitbox { position:absolute; z-index:20; opacity:0; border:1px solid red; }
        .debug .hitbox { opacity:0.5; background:rgba(255,0,0,0.2); } .debug .path { border-color:white; background:rgba(255,255,255,0.1); }
        /* UI */
        h1 { font-size:10vh; margin:0 0 5vh 0; text-transform:uppercase; color:#000; }
        .circle { display:inline-flex; width:12vh; height:12vh; border-radius:50%; background:#f2a922; border:0.5vh solid #333; margin:2vh; cursor:pointer; font-weight:bold; align-items:center; justify-content:center; color:#000; transition:0.1s; }
        .circle:active { transform:scale(0.9); }
        /* ANIMATIONS */
        @keyframes openDoor { 100% { transform:translateY(-150%); } }
    </style>
</head>
<body>
    <div id="game">
        <div id="gfx" class="layer" style="z-index:10"></div>
        <div id="phy" class="layer"></div>
        <div id="ui" class="layer">
            <h1>World 2</h1>
            <div class="circle" onclick="Game.start(6)">CONT</div>
            <div class="circle" onclick="location.href='../index.html'">EXIT</div>
        </div>
    </div>

<script>
// --- LEVELS ---
const LevelData = {
    6: (d) => {
        // The Button Puzzle
        d.path(18, 38, 30, 20); 
        d.path(40, 20, 8, 60);
        d.path(40, 20, 35, 14);
        d.path(40, 66, 65, 14);
        d.goal(90, 66, 8, 14, 7);
        
        // Door Mechanism
        const door = d.obs(60, 66, 8, 14); 
        d.btn(70, 20, 8, 14, (btn) => {
            if(btn.triggered) return;
            btn.triggered = true;
            btn.vis.classList.add('on'); // Visual feedback
            // Animate Visual AND Hitbox to open path
            door.vis.style.animation = "openDoor 1s forwards";
            door.hit.style.animation = "openDoor 1s forwards";
        });
    },
    7: (d) => {
        d.path(10, 20, 10, 60);
        d.path(10, 80, 80, 14);
        d.goal(80, 20, 8, 14, 'win'); 
    }
};

const Game = {
    active: false, mx:0, my:0, mobile:false, holding:false, hitboxes:[],
    els: { gfx:document.getElementById('gfx'), phy:document.getElementById('phy'), ui:document.getElementById('ui') },

    init() {
        this.mobile = 'ontouchstart' in window;
        const move = (x,y) => { this.mx=x; this.my=y; };
        
        window.addEventListener('mousemove', e => move(e.clientX, e.clientY));
        window.addEventListener('touchmove', e => { e.preventDefault(); move(e.touches[0].clientX, e.touches[0].clientY); }, {passive:false});
        
        // Hold/Tap Logic
        const down = () => this.holding=true;
        const up = () => { this.holding=false; if(this.active && this.mobile) this.die(); };
        window.addEventListener('mousedown', down); window.addEventListener('touchstart', down);
        window.addEventListener('mouseup', up); window.addEventListener('touchend', up);

        // Mark save file
        localStorage.setItem('touchYellow_save1', 'true');
        this.loop();
    },

    start(id) {
        this.reset();
        this.active = true; this.els.ui.style.display='none';
        
        // Builder
        const builder = {
            path: (x,y,w,h) => this.spawn(x,y,w,h,'path'),
            obs: (x,y,w,h) => this.spawn(x,y,w,h,'obs'),
            goal: (x,y,w,h,n) => this.spawn(x,y,w,h,'goal',n),
            btn: (x,y,w,h,cb) => this.spawn(x,y,w,h,'btn',null,cb)
        };

        if(LevelData[id]) LevelData[id](builder);
        else { alert("World 2 Complete!"); location.href='../index.html'; }
    },

    spawn(x,y,w,h,type,next,cb) {
        const s = {left:x+'%', top:y+'%', width:w+'%', height:h+'%'};
        
        const v = document.createElement('div'); v.className=`obj ${type}`; Object.assign(v.style, s);
        this.els.gfx.appendChild(v);
        
        const p = document.createElement('div'); p.className=`hitbox ${type}`; Object.assign(p.style, s);
        this.els.phy.appendChild(p);

        const obj = { vis:v, hit:p, type, next, cb, triggered:false };
        this.hitboxes.push(obj);
        return obj; // Return reference for scripts
    },

    loop() {
        requestAnimationFrame(()=>this.loop());
        if(!this.active) return;
        
        const r = document.getElementById('game').getBoundingClientRect();
        const mx = (this.mx - r.left)/r.width*100;
        const my = (this.my - r.top)/r.height*100;
        
        if(mx<0||mx>100||my<0||my>100) return this.die();
        if(this.mobile && !this.holding) return;

        let safe = false;
        
        for(let hb of this.hitboxes) {
            const hr = hb.hit.getBoundingClientRect();
            // Collision Check
            const bx=(hr.left-r.left)/r.width*100, by=(hr.top-r.top)/r.height*100;
            const bw=hr.width/r.width*100, bh=hr.height/r.height*100;

            if(mx>bx && mx<bx+bw && my>by && my<by+bh) {
                if(hb.type === 'obs') return this.die();
                if(hb.type === 'path') safe = true;
                if(hb.type === 'goal') { safe=true; this.start(hb.next); }
                if(hb.type === 'btn') { safe=true; if(hb.cb) hb.cb(hb); }
            }
        }
        if(!safe) this.die();
    },

    die() {
        this.active = false;
        document.body.style.background = '#500';
        setTimeout(() => { document.body.style.background = '#000'; this.start(6); }, 200);
    },
    reset() { this.active=false; this.hitboxes=[]; this.els.gfx.innerHTML=''; this.els.phy.innerHTML=''; }
};

Game.init();
window.cmd = (c) => { if(c==='hitbox') document.getElementById('game').classList.toggle('debug'); };
</script>
</body>
</html>