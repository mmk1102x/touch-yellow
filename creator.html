<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Touch Yellow - Ultimate Creator</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- LAYOUT --- */
        body { margin:0; background:#222; font-family:'Roboto', sans-serif; color:white; height:100vh; display:flex; flex-direction:column; overflow:hidden; user-select:none; }
        
        /* TOOLBAR */
        #toolbar { height:50px; background:#1a1a1a; display:flex; align-items:center; padding:0 15px; gap:10px; border-bottom:1px solid #444; overflow-x: auto; }
        button { background:#444; border:1px solid #222; color:#eee; padding:5px 10px; cursor:pointer; font-size:12px; border-radius:4px; white-space: nowrap; }
        button:hover { background:#555; } button.active { background:#666; border-color:#999; box-shadow:inset 0 0 4px #000; }
        button.prm { background:#f2a922; color:#000; border-color:#b37a15; font-weight:bold; }
        button.danger { background:#a33; border-color:#600; }
        
        .tool-group { display:flex; gap:5px; border-right:1px solid #444; padding-right:10px; align-items:center; }
        label { font-size:11px; color:#aaa; display:flex; align-items:center; gap:4px; cursor:pointer; }
        input[type=checkbox] { margin:0; }

        /* WORKSPACE */
        #workspace { flex:1; display:flex; }
        #sidebar { width:280px; background:#222; border-left:1px solid #333; padding:10px; display:flex; flex-direction:column; gap:10px; font-size:12px; overflow-y:auto; }
        #canvas { flex:1; position:relative; overflow:hidden; background-image:radial-gradient(#444 1px, transparent 1px); background-size:20px 20px; display:flex; justify-content:center; align-items:center; }
        #game-container { width:80%; aspect-ratio:16/9; position:relative; background:#000; box-shadow:0 0 50px #000; border:1px solid #333; }
        
        /* OBJECTS */
        .obj { position:absolute; box-sizing:border-box; box-shadow: 0 0 0 1px rgba(0,0,0,0.2); }
        .t-path { background-color:#26a9e1; opacity:0.9; } 
        .t-goal { background-color:#f1a92a; opacity:0.9; } 
        .t-obs { background-color:#000; border:1px dashed #555; opacity:0.8; }
        .t-btn { background-color:#33cc33; opacity:0.9; } 
        .t-trig { background:rgba(150,0,255,0.3); border:2px solid #b0f; }
        .t-start { border:2px solid lime; border-radius:50%; background:transparent; display:flex; justify-content:center; align-items:center; } 
        .t-start::after { content:"S"; color:lime; font-weight:bold; }
        
        /* GIZMOS */
        .gizmo { position:absolute; border:2px solid #fff; pointer-events:none; z-index:9999 !important; }
        .handle { position:absolute; width:10px; height:10px; background:#fff; border:1px solid #000; pointer-events:auto; }
        .h-tl { top:-6px; left:-6px; cursor:nw-resize; }
        .h-tr { top:-6px; right:-6px; cursor:ne-resize; }
        .h-bl { bottom:-6px; left:-6px; cursor:sw-resize; }
        .h-br { bottom:-6px; right:-6px; cursor:se-resize; }
        
        /* Rotation Gizmo */
        .rotate-stem { position:absolute; top:-20px; left:50%; width:1px; height:20px; background:#fff; pointer-events:none; }
        .rotate-knob { position:absolute; top:-28px; left:50%; width:10px; height:10px; background:#f2a922; border:1px solid #fff; border-radius:50%; transform:translateX(-50%); cursor:grab; pointer-events:auto; }

        /* PATHS */
        svg { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:9000; }
        path { stroke:#f2a922; stroke-width:2; fill:none; stroke-dasharray:5; }
        .kf-node { position:absolute; width:10px; height:10px; background:#f2a922; border:2px solid #fff; border-radius:50%; transform:translate(-50%,-50%); z-index:9500; cursor:grab; }

        /* SIDEBAR PROPS */
        .panel { background:#2a2a2a; border:1px solid #333; padding:8px; border-radius:4px; }
        .row { display:flex; justify-content:space-between; align-items:center; margin-bottom:5px; }
        .row label { color:#888; width:60px; }
        input[type=number], input[type=text] { flex:1; background:#111; border:1px solid #444; color:#fff; padding:4px; }
        .z-ctrl { display:flex; gap:2px; flex:1; } 
        .z-ctrl button { width:auto; padding:2px 8px; } .z-ctrl input { text-align:center; }
        
        #kf-list { max-height:100px; overflow-y:auto; border:1px solid #333; margin-top:5px; }
        .kf-item { display:flex; gap:5px; padding:2px; font-size:11px; }

        #play-layer { position:absolute; inset:0; pointer-events:none; z-index:200; display:none; }
        .paused { animation-play-state: paused !important; }
        #style-dump { display:none; }
    </style>
    <style id="style-dump"></style>
</head>
<body>
    <div id="toolbar">
        <div class="tool-group">
            <button class="prm" onclick="Ed.togglePlay()">â–¶ PLAY</button>
        </div>
        <div class="tool-group">
            <button id="t-sel" class="active" onclick="Ed.setTool('sel')">Select</button>
            <button id="t-path" onclick="Ed.setTool('path')">Path</button>
            <label><input type="checkbox" id="chk-snap" checked> Snap</label>
        </div>
        <div class="tool-group">
            <button onclick="Ed.add('path')">+Blk</button>
            <button onclick="Ed.add('obs')">+Obs</button>
            <button onclick="Ed.add('goal')">+Goal</button>
            <button onclick="Ed.add('btn')">+Btn</button>
            <button onclick="Ed.add('trig')">+Trig</button>
            <button onclick="Ed.add('start')">+Start</button>
        </div>
        <div class="tool-group">
            <button onclick="HistorySys.undo()">Undo</button>
            <button onclick="HistorySys.redo()">Redo</button>
        </div>
        <div class="tool-group" style="border:none">
            <button onclick="Ed.exportCode()">Code</button>
            <button onclick="Ed.exportHash()">Hash</button>
            <button onclick="Ed.importHash()">Load</button>
            <button class="prm" onclick="CookieSys.save()">Save(C)</button>
            <button onclick="CookieSys.load()">Load(C)</button>
            <button class="danger" onclick="Ed.clear()">CLR</button>
        </div>
    </div>

    <div id="workspace">
        <div id="canvas">
            <div id="game-container">
                <div id="l-obj"></div>
                <div id="l-giz"></div>
                <svg id="l-svg"></svg>
                <div id="l-pts"></div>
                <div id="play-layer"></div>
            </div>
        </div>
        <div id="sidebar">
            <div id="props" style="display:none">
                <div class="panel">
                    <div class="row" style="color:#f2a922; font-weight:bold"><span id="p-id">OBJ</span></div>
                    <div class="row"><label>X</label> <input type="number" id="v-x" onchange="Ed.set('x',this.value)"></div>
                    <div class="row"><label>Y</label> <input type="number" id="v-y" onchange="Ed.set('y',this.value)"></div>
                    <div class="row"><label>W</label> <input type="number" id="v-w" onchange="Ed.set('w',this.value)"></div>
                    <div class="row"><label>H</label> <input type="number" id="v-h" onchange="Ed.set('h',this.value)"></div>
                    <div class="row"><label>Rot</label> <input type="number" id="v-r" onchange="Ed.set('r',this.value)"></div>
                    <div class="row"><label>Z</label> <div class="z-ctrl"><button onclick="Ed.modZ(-1)">-</button><input type="number" id="v-z" onchange="Ed.set('z',this.value)" value="10"><button onclick="Ed.modZ(1)">+</button></div></div>
                </div>
                <div class="panel">
                    <div class="row" style="color:#ddd">Logic</div>
                    <div class="row"><label>Tag</label> <input type="text" id="v-tag" onchange="Ed.setStr('tag',this.value)"></div>
                    <div class="row"><label>Link</label> <input type="text" id="v-link" onchange="Ed.setStr('link',this.value)"></div>
                </div>
                <div class="panel">
                    <div class="row" style="color:#ddd">Anim</div>
                    <div class="row"><label>Wait</label> <input type="checkbox" id="v-wait" onchange="Ed.setBool('wait',this.checked)"></div>
                    <div class="row"><label>Dur</label> <input type="number" id="v-dur" value="2" onchange="Ed.set('dur',this.value)"></div>
                    <div class="row"><button onclick="Ed.addKf()">+ KF</button><button onclick="Ed.clearKf()">Reset</button></div>
                    <div id="kf-list"></div>
                </div>
                <button class="danger" style="width:100%" onclick="Ed.del()">DELETE</button>
            </div>
            <div id="no-sel" style="text-align:center; color:#666; margin-top:50px;">No Selection</div>
        </div>
    </div>

<script>
// --- HISTORY ---
const HistorySys={stack:[],future:[],push(){if(this.stack.length>50)this.stack.shift();this.stack.push(JSON.parse(JSON.stringify(Ed.objs)));this.future=[];},undo(){if(this.stack.length){this.future.push(JSON.parse(JSON.stringify(Ed.objs)));Ed.objs=this.stack.pop();Ed.sel=null;Ed.render();}},redo(){if(this.future.length){this.stack.push(JSON.parse(JSON.stringify(Ed.objs)));Ed.objs=this.future.pop();Ed.sel=null;Ed.render();}}};
window.addEventListener('keydown',(e)=>{if(e.target.tagName==='INPUT')return;if((e.ctrlKey||e.metaKey)&&e.key==='z'){e.preventDefault();HistorySys.undo();}if((e.ctrlKey||e.metaKey)&&e.key==='y'){e.preventDefault();HistorySys.redo();}if(e.key==='Delete')Ed.del();});

// --- COOKIE & EXPORT ---
const CookieSys={
    save:()=>{
        try {
            const data=Ed.pack(); 
            const s=btoa(JSON.stringify(data)); 
            if(s.length>4090)return alert("Too big for Cookie!"); 
            document.cookie=`ty_level=${s};max-age=31536000;path=/`; 
            alert("Saved to Cookie");
        } catch(e){ alert("Error"); }
    }, 
    load:()=>{
        const m=document.cookie.match(/ty_level=([^;]+)/); 
        if(m){
            Ed.unpack(JSON.parse(atob(m[1]))); 
            alert("Loaded");
        } else alert("No Save");
    }
};

// --- MAIN EDITOR ---
const Ed = {
    objs: [], sel: null, tool: 'sel', drag: null, playing: false,
    els: { 
        obj:document.getElementById('l-obj'), 
        giz:document.getElementById('l-giz'), 
        svg:document.getElementById('l-svg'), 
        pts:document.getElementById('l-pts'), 
        props:document.getElementById('props'), 
        no:document.getElementById('no-sel') 
    },
    
    init() { 
        // Bind Canvas Events in JS to prevent ReferenceError
        const cvs = document.getElementById('canvas');
        cvs.addEventListener('mousedown', (e) => this.down(e));
        cvs.addEventListener('mousemove', (e) => this.move(e));
        cvs.addEventListener('mouseup',   (e) => this.up(e));
        
        this.add('start', 5, 50, 6, 10); 
    },
    
    // Data Packing
    pack() { 
        return this.objs.map(o=>[ ['path','obs','goal','start','btn','trig'].indexOf(o.type), o.x, o.y, o.w, o.h, o.r, o.kfs, o.tag, o.link, o.wait?1:0, o.dur, o.z||10 ]); 
    },
    unpack(d) { 
        this.objs=d.map(r=>({id:Math.random(), type:['path','obs','goal','start','btn','trig'][r[0]], x:r[1], y:r[2], w:r[3], h:r[4], r:r[5]||0, kfs:r[6]||[], tag:r[7]||"", link:r[8]||"", wait:!!r[9], dur:r[10]||2, z:r[11]||10 })); 
        this.render(); 
    },

    add(type,x=40,y=40,w=10,h=10) { 
        HistorySys.push(); 
        let z=10; if(type==='obs')z=20; if(type==='btn')z=15;
        this.objs.push({id:Math.random(), type, x, y, w, h, r:0, z, kfs:[], tag:"", link:"", wait:false, dur:2 });
        this.render(); 
    },

    setTool(t) { 
        this.tool=t; 
        document.querySelectorAll('#toolbar button').forEach(b=>b.classList.remove('active'));
        document.getElementById(t==='sel'?'t-sel':'t-path').classList.add('active');
        this.render();
    },

    render() {
        if(this.playing) return;
        ['obj','giz','pts'].forEach(k=>this.els[k].innerHTML=''); this.els.svg.innerHTML='';
        
        [...this.objs].sort((a,b)=>(a.z||10)-(b.z||10)).forEach(o => {
            const el = document.createElement('div');
            el.className = `obj t-${o.type}`;
            Object.assign(el.style, { left:o.x+'%', top:o.y+'%', width:o.w+'%', height:o.h+'%', transform:`rotate(${o.r}deg)`, zIndex:o.z||10 });
            el.onmousedown = (e) => this.startDrag(e, o, 'move');
            this.els.obj.appendChild(el);

            if(this.sel === o) {
                // Gizmo
                const g = document.createElement('div'); g.className='gizmo';
                Object.assign(g.style, { left:o.x+'%', top:o.y+'%', width:o.w+'%', height:o.h+'%', transform:`rotate(${o.r}deg)`, zIndex:9999 });
                
                // Handles
                ['tl','tr','bl','br'].forEach(p => {
                    const h = document.createElement('div'); h.className=`handle h-${p}`;
                    h.onmousedown = (e) => this.startDrag(e, o, 'scale', p);
                    g.appendChild(h);
                });
                
                // Rotate
                const stem = document.createElement('div'); stem.className='rotate-stem';
                const knob = document.createElement('div'); knob.className='rotate-knob';
                knob.onmousedown = (e) => this.startDrag(e, o, 'rotate');
                g.append(stem, knob);
                
                this.els.giz.appendChild(g);
                this.renderPath(o);
            }
        });
        this.updateUI();
    },

    renderPath(o) {
        if(!o.kfs.length && this.tool!=='path') return;
        let d = `M ${o.x+o.w/2} ${o.y+o.h/2}`;
        o.kfs.forEach(k => {
            const ax = o.x+o.w/2 + (k.x/100*o.w);
            const ay = o.y+o.h/2 + (k.y/100*o.h);
            d += ` L ${ax} ${ay}`;
            const pt=document.createElement('div'); pt.className='kf-node';
            pt.style.left=ax+'%'; pt.style.top=ay+'%';
            this.els.pts.appendChild(pt);
        });
        const p = document.createElementNS("http://www.w3.org/2000/svg","path"); p.setAttribute("d",d); this.els.svg.appendChild(p);
    },

    startDrag(e, o, mode, handle) {
        e.stopPropagation();
        if(this.tool==='path' && mode==='move') { this.addKf(e,o); return; }
        
        this.sel = o; this.render(); HistorySys.push();
        this.drag = { mode, o, sx:e.clientX, sy:e.clientY, handle, ox:o.x, oy:o.y, ow:o.w, oh:o.h, or:o.r };
    },

    move(e) {
        if(!this.drag) return;
        const r = document.getElementById('game-container').getBoundingClientRect();
        const dx = (e.clientX - this.drag.sx)/r.width*100;
        const dy = (e.clientY - this.drag.sy)/r.height*100;
        const o = this.drag.o;
        const snap = document.getElementById('chk-snap').checked;

        if(this.drag.mode === 'move') {
            o.x = this.drag.ox + dx; o.y = this.drag.oy + dy;
            if(snap) { o.x=Math.round(o.x); o.y=Math.round(o.y); }
        } 
        else if(this.drag.mode === 'scale') {
            let nw=o.w, nh=o.h, nx=o.x, ny=o.y;
            if(this.drag.handle.includes('r')) nw = Math.max(1, this.drag.ow + dx);
            if(this.drag.handle.includes('l')) { let d = Math.min(this.drag.ow-1, dx); nw = this.drag.ow - d; nx = this.drag.ox + d; }
            if(this.drag.handle.includes('b')) nh = Math.max(1, this.drag.oh + dy);
            if(this.drag.handle.includes('t')) { let d = Math.min(this.drag.oh-1, dy); nh = this.drag.oh - d; ny = this.drag.oy + d; }
            
            if(snap) { nw=Math.round(nw); nh=Math.round(nh); nx=Math.round(nx); ny=Math.round(ny); }
            o.x=nx; o.y=ny; o.w=nw; o.h=nh;
        }
        else if(this.drag.mode === 'rotate') {
            const cx = r.left + (o.x + o.w/2)/100 * r.width;
            const cy = r.top + (o.y + o.h/2)/100 * r.height;
            const angle = Math.atan2(e.clientY - cy, e.clientX - cx) * (180/Math.PI);
            let rot = angle + 90;
            if(snap) rot = Math.round(rot/15)*15;
            o.r = rot;
        }
        this.render(); this.updateUI();
    },

    up() { this.drag = null; },
    down(e) { if(e.target.id === 'game-container') { this.sel=null; this.render(); } },

    updateUI() {
        if(!this.sel) { this.els.props.style.display='none'; this.els.no.style.display='block'; return; }
        this.els.props.style.display='block'; this.els.no.style.display='none';
        
        ['x','y','w','h','r','dur','z'].forEach(k => {
            const el = document.getElementById('v-'+k);
            if(el) el.value = Math.round((this.sel[k]||(k==='z'?10:0))*100)/100;
        });
        document.getElementById('p-id').innerText = this.sel.type;
        document.getElementById('v-tag').value = this.sel.tag;
        document.getElementById('v-link').value = this.sel.link;
        document.getElementById('v-wait').checked = this.sel.wait;
        
        const l = document.getElementById('kf-list'); l.innerHTML='';
        this.sel.kfs.forEach((k,i) => l.innerHTML += `<div class="kf-item"><span class="kf-idx">#${i+1}</span> X:<input type="number" value="${Math.round(k.x)}" onchange="Ed.setKf(${i},'x',this.value)"> Y:<input type="number" value="${Math.round(k.y)}" onchange="Ed.setKf(${i},'y',this.value)"></div>`);
    },

    set(k,v) { if(this.sel) { HistorySys.push(); this.sel[k]=parseFloat(v); this.render(); } },
    setStr(k,v) { if(this.sel) { HistorySys.push(); this.sel[k]=v; } },
    setBool(k,v) { if(this.sel) { HistorySys.push(); this.sel[k]=v; } },
    modZ(d) { if(this.sel) { HistorySys.push(); this.sel.z=(this.sel.z||10)+d; this.render(); } },
    setKf(i,k,v) { if(this.sel) { HistorySys.push(); this.sel.kfs[i][k]=parseFloat(v); this.render(); } },
    
    del() { if(this.sel) { HistorySys.push(); this.objs=this.objs.filter(o=>o!==this.sel); this.sel=null; this.render(); } },
    clear() { if(confirm("Clear?")) { HistorySys.push(); this.objs=[]; this.render(); } },
    addKf() { if(this.sel) { HistorySys.push(); this.sel.kfs.push({x:10,y:10}); this.render(); } },
    clearKf() { if(this.sel) { HistorySys.push(); this.sel.kfs=[]; this.render(); } },

    // --- EXPORTS ---
    exportHash() {
        const d = this.pack();
        const s = btoa(JSON.stringify(d));
        prompt("Copy Level Hash:", s);
    },
    importHash() {
        const s = prompt("Paste Level Hash:");
        if(s) {
            try { this.unpack(JSON.parse(atob(s))); } catch(e) { alert("Invalid"); }
        }
    },
    exportCode() {
        let js = `// Level Code\n(d) => {\n`;
        this.objs.forEach(o => {
            let animStr = "null";
            if(o.kfs.length) animStr = `"customAnim ${o.dur}s linear infinite"`; 
            const z = o.z && o.z !== 10 ? `, z:${o.z}` : '';
            
            if(o.type==='path') js += `    d.path(${o.x}, ${o.y}, ${o.w}, ${o.h}${z});\n`;
            if(o.type==='obs') js += `    d.obs(${o.x}, ${o.y}, ${o.w}, ${o.h}, ${animStr}${z});\n`;
            if(o.type==='goal') js += `    d.goal(${o.x}, ${o.y}, ${o.w}, ${o.h}, 'next');\n`;
        });
        js += `}`;
        console.log(js); alert("Code logged to Console (F12)");
    },

    togglePlay() {
        this.playing = !this.playing;
        const pl = document.getElementById('play-layer');
        const dump = document.getElementById('style-dump');
        if(this.playing) {
            pl.style.display='block'; pl.innerHTML=''; this.els.obj.style.display='none'; this.els.giz.style.display='none';
            let css = "";
            this.objs.forEach(o => {
                const el = document.createElement('div');
                el.className = `obj t-${o.type} ${o.wait?'paused':''}`;
                if(o.tag) el.id = "run-"+o.tag;
                Object.assign(el.style, { left:o.x+'%', top:o.y+'%', width:o.w+'%', height:o.h+'%', zIndex:o.z||10, transform:`rotate(${o.r}deg)` });
                
                if(o.kfs.length) {
                    const nm = `anim-${Math.random().toString(36).substr(2,5)}`;
                    css += `@keyframes ${nm} { 0% { transform: translate(0,0) rotate(${o.r}deg); } `;
                    o.kfs.forEach((k,i) => {
                        const pct = Math.round((i+1)/(o.kfs.length+1)*100);
                        css += `${pct}% { transform: translate(${k.x}%, ${k.y}%) rotate(${o.r}deg); } `;
                    });
                    css += `100% { transform: translate(0,0) rotate(${o.r}deg); } } `;
                    el.style.animation = `${nm} ${o.dur}s linear infinite`;
                }
                
                // Logic Sim
                if(o.type==='btn' || o.type==='trig') {
                    el.onmouseenter = () => { if(o.link) { const t=document.getElementById("run-"+o.link); if(t) t.classList.remove('paused'); } };
                    el.style.pointerEvents="auto";
                }
                pl.appendChild(el);
            });
            dump.innerHTML = css;
        } else {
            pl.style.display='none'; this.els.obj.style.display='block'; this.els.giz.style.display='block'; this.render();
        }
    }
};

Ed.init();
</script>
</body>
</html>