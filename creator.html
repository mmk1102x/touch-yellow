<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Touch Yellow - Creator</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%23f2a922' stroke='%23333' stroke-width='10'/></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Roboto:wght@700&display=swap" rel="stylesheet">
    
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; width: 100vw; height: 100vh; background: #222; font-family: 'Roboto', sans-serif; display: flex; flex-direction: column; overflow: hidden; color: white; }
        
        /* EDITOR LAYOUT */
        #toolbar { height: 60px; background: #333; display: flex; align-items: center; padding: 0 20px; border-bottom: 2px solid #444; }
        #workspace { flex: 1; display: flex; position: relative; }
        #sidebar { width: 300px; background: #2a2a2a; border-left: 2px solid #444; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        
        /* CANVAS AREA */
        #canvas-wrapper { flex: 1; display: flex; justify-content: center; align-items: center; background-image: radial-gradient(#444 1px, transparent 1px); background-size: 20px 20px; position: relative; }
        
        #game-container {
            width: 80%; aspect-ratio: 16/9; position: relative; background: #000000; 
            box-shadow: 0 0 30px rgba(0,0,0,0.5); overflow: hidden;
            border: 2px solid #555;
        }

        /* EDITOR UI OBJECTS */
        .obj { position: absolute; cursor: grab; box-sizing: border-box; }
        .obj:hover { outline: 2px solid white; z-index: 100; }
        .obj.selected { outline: 3px solid #f2a922; z-index: 101; }
        
        /* Visual Styles (Matched to Game) */
        .v-path { background-color: #26a9e1; box-shadow: 0 0 0 1px #26a9e1; }
        .v-goal { background-color: #f1a92a; box-shadow: 0 0 0 1px #f1a92a; }
        .v-obs { background-color: #000000; border: 1px dashed #555; } /* Dashed border to see black on black */
        .v-btn { background-color: #33cc33; }
        .v-trig { background-color: rgba(150, 0, 255, 0.3); border: 2px solid #b0f; }

        /* BUTTONS */
        button { background: #444; border: 1px solid #666; color: white; padding: 8px 12px; cursor: pointer; border-radius: 4px; font-weight: bold; transition: 0.1s; }
        button:hover { background: #555; }
        button.primary { background: #f2a922; color: black; border-color: #b37a15; }
        button.danger { background: #cc3333; border-color: #992222; }
        
        .tool-group { display: flex; gap: 10px; margin-right: 20px; }

        /* PROPERTY INPUTS */
        .prop-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .prop-row label { font-size: 12px; color: #aaa; }
        .prop-row input { width: 60px; background: #111; border: 1px solid #444; color: white; padding: 4px; border-radius: 3px; }
        .prop-row input.long { width: 100%; }

        /* KEYFRAME EDITOR MODAL */
        #kf-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 2000;
            display: none; justify-content: center; align-items: center;
        }
        .modal-content {
            background: #333; padding: 20px; border-radius: 8px; width: 500px;
            border: 2px solid #f2ef45;
        }
        .kf-list { max-height: 300px; overflow-y: auto; margin: 10px 0; background: #222; padding: 10px; }
        .kf-item { display: flex; gap: 10px; margin-bottom: 5px; }

        /* PLAY MODE OVERLAY */
        #play-overlay { position: absolute; top: 10px; left: 10px; pointer-events: none; display: none; }
        .play-active #game-container { border-color: #0f0; }

        /* IN-GAME ENGINE STYLES (Copied for Preview) */
        .hitbox { position: absolute; opacity: 0; cursor: crosshair; }
        #catch-meter { position: fixed; display: none; width: 40px; height: 6px; background: #333; border: 1px solid white; z-index: 9999; }
        #catch-fill { width: 0%; height: 100%; background: #00ff00; }
    </style>
    <style id="dynamic-css"></style>
</head>
<body>

    <!-- TOOLBAR -->
    <div id="toolbar">
        <div class="tool-group">
            <button class="primary" onclick="Creator.togglePlay()">â–¶ PLAY / STOP</button>
        </div>
        <div class="tool-group">
            <button onclick="Creator.add('path')">+ Path</button>
            <button onclick="Creator.add('obs')">+ Obstacle</button>
            <button onclick="Creator.add('goal')">+ Goal</button>
            <button onclick="Creator.add('btn')">+ Button</button>
            <button onclick="Creator.add('trig')">+ Trigger</button>
        </div>
        <div class="tool-group" style="margin-left: auto;">
            <button onclick="Creator.exportCode()">Copy Code</button>
            <button onclick="Creator.exportJson()">Save JSON</button>
            <button onclick="Creator.importJson()">Load JSON</button>
            <button class="danger" onclick="Creator.clear()">Clear All</button>
        </div>
    </div>

    <div id="workspace">
        <!-- CANVAS -->
        <div id="canvas-wrapper">
            <div id="game-container" onmousemove="Creator.onMouseMove(event)" onmouseup="Creator.onMouseUp(event)">
                <div id="editor-layer"></div>
                <div id="engine-layer"></div> <!-- Real game runs here -->
            </div>
            <div id="play-overlay"><h2 style="color:lime; margin:0; text-shadow: 2px 2px 0 #000;">PLAYING</h2></div>
        </div>

        <!-- PROPERTIES SIDEBAR -->
        <div id="sidebar">
            <h3>Properties</h3>
            <div id="no-selection" style="color:#777; font-style:italic;">Select an object to edit</div>
            
            <div id="prop-form" style="display:none;">
                <div class="prop-row"><label>Type</label><span id="p-type" style="font-weight:bold; color:#f2a922"></span></div>
                <div class="prop-row"><label>X (%)</label><input type="number" id="p-x" onchange="Creator.updateProp('x', this.value)"></div>
                <div class="prop-row"><label>Y (%)</label><input type="number" id="p-y" onchange="Creator.updateProp('y', this.value)"></div>
                <div class="prop-row"><label>W (%)</label><input type="number" id="p-w" onchange="Creator.updateProp('w', this.value)"></div>
                <div class="prop-row"><label>H (%)</label><input type="number" id="p-h" onchange="Creator.updateProp('h', this.value)"></div>
                
                <hr style="border-color:#444; width:100%;">
                
                <!-- Specific Props -->
                <div id="grp-anim">
                    <div class="prop-row"><label>Animation CSS</label></div>
                    <input type="text" class="long" id="p-anim" placeholder="name 2s linear infinite" onchange="Creator.updateProp('anim', this.value)">
                    <button style="width:100%; margin-top:5px;" onclick="KeyframeEditor.open()">Edit Keyframes</button>
                </div>

                <div id="grp-goal" style="display:none;">
                    <div class="prop-row"><label>Next Level ID</label><input type="text" id="p-next" onchange="Creator.updateProp('next', this.value)"></div>
                    <div class="prop-row"><label>Hold Time (ms)</label><input type="number" id="p-hold" onchange="Creator.updateProp('holdTime', this.value)"></div>
                </div>

                <div id="grp-logic" style="display:none;">
                    <div class="prop-row"><label>Target ID</label><input type="text" id="p-target" placeholder="door-1" onchange="Creator.updateProp('targetId', this.value)"></div>
                </div>

                <div style="margin-top:20px;">
                    <button class="danger" style="width:100%" onclick="Creator.deleteSelected()">Delete Object</button>
                </div>
            </div>
        </div>
    </div>

    <!-- KEYFRAME EDITOR MODAL -->
    <div id="kf-modal">
        <div class="modal-content">
            <h3>Keyframe Editor</h3>
            <p style="font-size:12px; color:#aaa;">Define steps (0-100%). X/Y are relative offsets (e.g. 100% X = move right by 1 width).</p>
            <div id="kf-list" class="kf-list"></div>
            <button onclick="KeyframeEditor.addStep()">+ Add Step</button>
            <div style="margin-top:20px; display:flex; justify-content:flex-end; gap:10px;">
                <button onclick="document.getElementById('kf-modal').style.display='none'">Cancel</button>
                <button class="primary" onclick="KeyframeEditor.save()">Save Animation</button>
            </div>
        </div>
    </div>

    <!-- CATCH METER (For Play Mode) -->
    <div id="catch-meter"><div id="catch-fill"></div></div>

    <script>
        /**
         * CREATOR ENGINE
         */
        const Creator = {
            objects: [],
            selectedId: null,
            isPlaying: false,
            dragging: null,
            
            // DOM Elements
            layer: document.getElementById('editor-layer'),
            engLayer: document.getElementById('engine-layer'),
            form: document.getElementById('prop-form'),
            noSel: document.getElementById('no-selection'),

            init: function() {
                // Add initial start/goal just to have something
                this.add('path', 10, 50, 20, 14);
            },

            add: function(type, x=40, y=40, w=10, h=10) {
                const id = Date.now().toString();
                const obj = { id, type, x, y, w, h, anim: '', next: 'menu', holdTime: 0, targetId: '' };
                this.objects.push(obj);
                this.render();
                this.select(id);
            },

            render: function() {
                this.layer.innerHTML = '';
                this.objects.forEach(obj => {
                    const el = document.createElement('div');
                    el.className = `obj v-${obj.type} ${this.selectedId === obj.id ? 'selected' : ''}`;
                    el.style.left = obj.x + '%';
                    el.style.top = obj.y + '%';
                    el.style.width = obj.w + '%';
                    el.style.height = obj.h + '%';
                    
                    // Mouse Interactions
                    el.onmousedown = (e) => {
                        e.stopPropagation();
                        this.select(obj.id);
                        this.dragging = { id: obj.id, startX: e.clientX, startY: e.clientY, ox: obj.x, oy: obj.y };
                    };

                    this.layer.appendChild(el);
                });
            },

            select: function(id) {
                this.selectedId = id;
                this.render();
                this.updateForm();
            },

            updateForm: function() {
                const obj = this.objects.find(o => o.id === this.selectedId);
                if (!obj) {
                    this.form.style.display = 'none';
                    this.noSel.style.display = 'block';
                    return;
                }
                
                this.form.style.display = 'block';
                this.noSel.style.display = 'none';
                
                document.getElementById('p-type').innerText = obj.type.toUpperCase();
                document.getElementById('p-x').value = obj.x;
                document.getElementById('p-y').value = obj.y;
                document.getElementById('p-w').value = obj.w;
                document.getElementById('p-h').value = obj.h;
                
                // Show/Hide specific groups
                document.getElementById('grp-anim').style.display = (obj.type === 'obs' || obj.type === 'goal') ? 'block' : 'none';
                document.getElementById('p-anim').value = obj.anim || '';
                
                document.getElementById('grp-goal').style.display = (obj.type === 'goal') ? 'block' : 'none';
                document.getElementById('p-next').value = obj.next || 'menu';
                document.getElementById('p-hold').value = obj.holdTime || 0;

                document.getElementById('grp-logic').style.display = (obj.type === 'btn' || obj.type === 'trig') ? 'block' : 'none';
                document.getElementById('p-target').value = obj.targetId || '';
            },

            updateProp: function(key, val) {
                const obj = this.objects.find(o => o.id === this.selectedId);
                if (obj) {
                    obj[key] = isNaN(val) ? val : parseFloat(val); // Keep strings if needed
                    this.render();
                }
            },

            deleteSelected: function() {
                if (this.selectedId) {
                    this.objects = this.objects.filter(o => o.id !== this.selectedId);
                    this.selectedId = null;
                    this.render();
                    this.updateForm();
                }
            },

            onMouseMove: function(e) {
                if (this.dragging) {
                    const rect = document.getElementById('game-container').getBoundingClientRect();
                    const dx = ((e.clientX - this.dragging.startX) / rect.width) * 100;
                    const dy = ((e.clientY - this.dragging.startY) / rect.height) * 100;
                    
                    const obj = this.objects.find(o => o.id === this.dragging.id);
                    if (obj) {
                        // Snap to 1%
                        obj.x = Math.round(this.dragging.ox + dx);
                        obj.y = Math.round(this.dragging.oy + dy);
                        this.render();
                        this.updateForm();
                    }
                }
            },

            onMouseUp: function() {
                this.dragging = null;
            },
            
            clear: function() {
                if(confirm("Delete all objects?")) {
                    this.objects = [];
                    this.render();
                    this.updateForm();
                }
            },

            // --- EXPORT ---
            exportCode: function() {
                let code = `// Paste this into LevelData\n`;
                code += `(draw) => {\n`;
                this.objects.forEach(o => {
                    if (o.type === 'path') code += `    draw.path(${o.x}, ${o.y}, ${o.w}, ${o.h});\n`;
                    if (o.type === 'goal') code += `    draw.goal(${o.x}, ${o.y}, ${o.w}, ${o.h}, "${o.next}", ${o.holdTime});\n`;
                    if (o.type === 'obs')  code += `    draw.obstacle(${o.x}, ${o.y}, ${o.w}, ${o.h}, "${o.anim}");\n`;
                    if (o.type === 'btn')  code += `    draw.button(${o.x}, ${o.y}, ${o.w}, ${o.h}, (b)=>{ /* Logic for ${o.targetId} */ });\n`;
                });
                code += `}`;
                
                navigator.clipboard.writeText(code).then(() => alert("Code copied to clipboard!"));
            },

            exportJson: function() {
                const data = JSON.stringify(this.objects);
                const hash = btoa(data);
                prompt("Copy this Level Hash:", hash);
            },

            importJson: function() {
                const hash = prompt("Paste Level Hash:");
                if (hash) {
                    try {
                        this.objects = JSON.parse(atob(hash));
                        this.render();
                        this.selectedId = null;
                        this.updateForm();
                    } catch(e) { alert("Invalid Hash"); }
                }
            },

            // --- PLAYTEST ENGINE ---
            togglePlay: function() {
                this.isPlaying = !this.isPlaying;
                document.body.classList.toggle('play-active', this.isPlaying);
                document.getElementById('play-overlay').style.display = this.isPlaying ? 'block' : 'none';
                
                if (this.isPlaying) {
                    this.layer.style.display = 'none'; // Hide editor view
                    PlayEngine.start(this.objects);
                } else {
                    this.layer.style.display = 'block';
                    PlayEngine.stop();
                }
            }
        };

        /**
         * KEYFRAME EDITOR
         */
        const KeyframeEditor = {
            steps: [],
            open: function() {
                document.getElementById('kf-modal').style.display = 'flex';
                this.renderList();
            },
            addStep: function() {
                this.steps.push({ pct: 0, x: 0, y: 0 });
                this.renderList();
            },
            renderList: function() {
                const c = document.getElementById('kf-list');
                c.innerHTML = '';
                this.steps.forEach((s, i) => {
                    c.innerHTML += `
                        <div class="kf-item">
                            <input type="number" placeholder="%" value="${s.pct}" onchange="KeyframeEditor.steps[${i}].pct=this.value">
                            <input type="number" placeholder="X%" value="${s.x}" onchange="KeyframeEditor.steps[${i}].x=this.value">
                            <input type="number" placeholder="Y%" value="${s.y}" onchange="KeyframeEditor.steps[${i}].y=this.value">
                            <button class="danger" onclick="KeyframeEditor.steps.splice(${i},1);KeyframeEditor.renderList()">X</button>
                        </div>
                    `;
                });
            },
            save: function() {
                // Generate CSS
                const name = "customAnim" + Date.now();
                let css = `@keyframes ${name} { `;
                this.steps.forEach(s => {
                    css += `${s.pct}% { transform: translate(${s.x}%, ${s.y}%); } `;
                });
                css += `}`;
                
                // Inject CSS
                const style = document.getElementById('dynamic-css');
                style.innerHTML += css;
                
                // Apply to object
                const animString = `${name} 2s linear infinite`;
                Creator.updateProp('anim', animString);
                document.getElementById('p-anim').value = animString;
                document.getElementById('kf-modal').style.display = 'none';
            }
        };

        /**
         * MINI PLAY ENGINE (Simplified from main game)
         */
        const PlayEngine = {
            active: false,
            hitboxes: [],
            
            start: function(objects) {
                this.active = true;
                const layer = document.getElementById('engine-layer');
                layer.innerHTML = '';
                this.hitboxes = [];

                // Build Level
                objects.forEach(o => {
                    const el = document.createElement('div');
                    // Map visual classes
                    const map = { 'path':'v-path', 'goal':'v-goal', 'obs':'v-obs', 'btn':'v-btn' };
                    el.className = `visual ${map[o.type]}`;
                    el.style.position = 'absolute';
                    el.style.left = o.x + '%'; el.style.top = o.y + '%';
                    el.style.width = o.w + '%'; el.style.height = o.h + '%';
                    
                    if (o.anim) el.style.animation = o.anim;
                    
                    layer.appendChild(el);
                    
                    // Create Hitbox Data
                    this.hitboxes.push({ el, type: o.type, holdTime: o.holdTime });
                });

                requestAnimationFrame(this.loop.bind(this));
            },

            stop: function() {
                this.active = false;
                document.getElementById('engine-layer').innerHTML = '';
            },

            loop: function() {
                if (!this.active) return;
                // Basic Collision Check (Mouse vs Rects)
                // Note: Since we don't have mouse tracking in this snippet for simplicity,
                // this acts as a visual preview. Full collision requires porting the mouse listeners.
                requestAnimationFrame(this.loop.bind(this));
            }
        };
        
        // Add Mouse Tracking for Play Engine
        let pMouseX = 0, pMouseY = 0;
        window.addEventListener('mousemove', e => { pMouseX = e.clientX; pMouseY = e.clientY; });

        // Augment loop for collision
        PlayEngine.loop = function() {
            if (!this.active) return;
            const target = document.elementFromPoint(pMouseX, pMouseY);
            
            // Simple Death Check for preview
            // In real engine we use geometry, here we use elementFromPoint for speed
            // If target is NULL or body, it's death
            const isSafe = target && (target.classList.contains('v-path') || target.classList.contains('v-goal') || target.classList.contains('v-btn'));
            
            if (!isSafe && target && target.id !== 'play-overlay') {
                // Flash red on death
                document.body.style.backgroundColor = '#500';
                setTimeout(() => document.body.style.backgroundColor = '#222', 100);
            }

            requestAnimationFrame(this.loop.bind(this));
        };

        Creator.init();

    </script>
</body>
</html>