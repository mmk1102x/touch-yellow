<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Touch Yellow</title>
    <style>
        body { margin:0; background:#000; overflow:hidden; font-family:'Roboto',sans-serif; height:100vh; display:flex; justify-content:center; align-items:center; user-select:none; touch-action:none; }
        #game { width:100%; max-width:177.7vh; aspect-ratio:16/9; position:relative; background:#000; box-shadow:0 0 50px #333; }
        .layer { position:absolute; inset:0; pointer-events:none; }
        #ui { z-index:500; pointer-events:auto; text-align:center; display:flex; flex-direction:column; justify-content:center; }
        /* ENTITIES */
        .obj { position:absolute; }
        .path { background:#26a9e1; } .goal { background:#f1a92a; } .obs { background:#000; } 
        .btn { background:#33cc33; border:1px solid #fff; } .btn.on { background:#228822; }
        /* HITBOXES */
        .hitbox { position:absolute; z-index:400; opacity:0; border:1px solid red; }
        .debug .hitbox { opacity:0.5; background:rgba(255,0,0,0.2); } .debug .path { border-color:white; background:rgba(255,255,255,0.1); }
        /* UI */
        h1 { color:#f2ef45; font-size:10vh; margin:0 0 5vh 0; text-transform:uppercase; text-shadow:4px 4px 0 #000; }
        .btn-ui { display:inline-flex; width:12vh; height:12vh; border-radius:50%; background:#f2a922; border:0.5vh solid #333; margin:2vh; cursor:pointer; font-weight:bold; align-items:center; justify-content:center; }
        .btn-ui:active { transform:scale(0.9); }
        .paused { animation-play-state: paused !important; }
        #hud { display:none; color:white; font-weight:bold; font-size:2vh; margin-top:45%; }
        #dynamic-css { display:none; }
    </style>
    <style id="dynamic-css"></style>
</head>
<body>
    <div id="game">
        <div id="gfx" class="layer" style="z-index:10"></div>
        <div id="phy" class="layer"></div>
        <div id="ui" class="layer">
            <div id="menu">
                <h1>Touch Yellow</h1>
                <div class="btn-ui" onclick="Game.start(1)">PLAY</div>
                <div class="btn-ui" onclick="Game.loadCustom()">CUSTOM</div>
                <div class="btn-ui" onclick="location.href='save/save1.html'" style="background:#00b0f0">W2</div>
            </div>
            <div id="hud">Move to Start</div>
        </div>
    </div>

<script>
const LevelData = {
    1: (d) => { d.path(0,40,60,20); d.goal(50,45,8,10,2); },
    2: (d) => { d.path(10,10,80,80); d.obs(40,10,20,80,'slicer 2s'); d.goal(80,80,10,10,3); },
    3: (d) => { d.path(0,45,100,10); d.goal(90,45,10,10,'win'); }
};
const BaseAnim = `@keyframes slicer { 0%,100%{transform:translateY(0)} 50%{transform:translateY(20%)} }`;

const Game = {
    active: false, mx:0, my:0, mobile:false, holding:false, hitboxes:[],
    els: { gfx:document.getElementById('gfx'), phy:document.getElementById('phy'), menu:document.getElementById('menu'), hud:document.getElementById('hud'), css:document.getElementById('dynamic-css') },

    init() {
        this.mobile = 'ontouchstart' in window;
        const move = (x,y) => { this.mx=x; this.my=y; };
        window.addEventListener('mousemove', e => move(e.clientX, e.clientY));
        window.addEventListener('touchmove', e => { e.preventDefault(); move(e.touches[0].clientX, e.touches[0].clientY); }, {passive:false});
        
        const down = () => this.holding=true;
        const up = () => { this.holding=false; if(this.active && this.mobile) this.die(); };
        window.addEventListener('mousedown', down); window.addEventListener('touchstart', down);
        window.addEventListener('mouseup', up); window.addEventListener('touchend', up);
        
        this.els.css.innerHTML = BaseAnim;
        this.loop();
    },

    start(id) {
        this.reset();
        this.active = true;
        this.els.menu.style.display='none'; this.els.hud.style.display='block';
        
        const builder = {
            path: (x,y,w,h) => this.spawn(x,y,w,h,'path'),
            obs: (x,y,w,h,a) => this.spawn(x,y,w,h,'obs',a),
            goal: (x,y,w,h,n) => this.spawn(x,y,w,h,'goal',null,n)
        };

        if(id === 'custom') this.parseCookie(builder);
        else if(LevelData[id]) LevelData[id](builder);
        else { alert("You Win!"); this.toMenu(); }
    },

    loadCustom() {
        if(document.cookie.indexOf('ty_level') === -1) return alert("No custom level found.");
        this.start('custom');
    },

    parseCookie(d) {
        try {
            const m = document.cookie.match(/ty_level=([^;]+)/);
            const data = JSON.parse(atob(m[1]));
            let css = "";
            data.forEach(o => {
                const types = ['path','obs','goal','start','btn','trig'];
                const t = types[o[0]];
                let anim = null;

                if(o[5] && o[5].length) {
                    const nm = `a-${Math.random().toString(36).substr(2)}`;
                    css += `@keyframes ${nm} { 0%{transform:translate(0,0)} `;
                    o[5].forEach((k,i) => css += `${Math.round((i+1)/(o[5].length+1)*100)}%{transform:translate(${k[0]}%,${k[1]}%)} `);
                    css += `100%{transform:translate(0,0)} } `;
                    anim = `${nm} ${o[9]||2}s linear infinite`;
                }

                // Spawn with Z-Index (o[10])
                const obj = this.spawn(o[1],o[2],o[3],o[4], t, anim, (t==='goal'?'menu':null));
                
                // Logic Props
                if(o[6]) obj.tag = o[6];
                if(o[7]) obj.link = o[7];
                if(o[8]) { obj.vis.classList.add('paused'); obj.hit.classList.add('paused'); }
                if(o[10]) obj.vis.style.zIndex = o[10]; // Apply Z-Layer
            });
            this.els.css.innerHTML += css;
        } catch(e) { console.error(e); alert("Load Error"); this.toMenu(); }
    },

    spawn(x,y,w,h,type,anim,next) {
        const s = {left:x+'%', top:y+'%', width:w+'%', height:h+'%'};
        const v = document.createElement('div'); v.className=`obj ${type}`; Object.assign(v.style, s);
        if(anim) v.style.animation = anim;
        this.els.gfx.appendChild(v);

        const p = document.createElement('div'); p.className=`hitbox ${type}`; Object.assign(p.style, s);
        if(anim) p.style.animation = anim;
        this.els.phy.appendChild(p);

        const obj = { vis:v, hit:p, type, next, tag:"", link:"" };
        this.hitboxes.push(obj);
        return obj;
    },

    loop() {
        requestAnimationFrame(()=>this.loop());
        if(!this.active) return;
        
        const r = document.getElementById('game').getBoundingClientRect();
        const mx = (this.mx - r.left)/r.width*100;
        const my = (this.my - r.top)/r.height*100;
        
        if(mx<0||mx>100||my<0||my>100) return this.die();
        if(this.mobile && !this.holding) return;

        let safe = false;
        
        for(let hb of this.hitboxes) {
            const hr = hb.hit.getBoundingClientRect();
            const bx=(hr.left-r.left)/r.width*100, by=(hr.top-r.top)/r.height*100;
            const bw=hr.width/r.width*100, bh=hr.height/r.height*100;

            if(mx>bx && mx<bx+bw && my>by && my<by+bh) {
                if(hb.type === 'obs') return this.die();
                if(hb.type === 'path' || hb.type === 'start') safe = true;
                if(hb.type === 'goal') { safe=true; this.win(hb.next); }
                if((hb.type==='btn' || hb.type==='trig') && hb.link) {
                    safe=true;
                    this.hitboxes.forEach(t => { if(t.tag === hb.link) { t.vis.classList.remove('paused'); t.hit.classList.remove('paused'); }});
                    if(hb.type==='btn') hb.vis.classList.add('on');
                }
            }
        }
        if(!safe) this.die();
    },

    win(next) { if(next==='menu') { alert("Complete!"); this.toMenu(); } else this.start(next); },
    die() { this.active=false; document.body.style.background='#500'; setTimeout(()=>{document.body.style.background='#000'; this.start(1);},200); },
    reset() { this.active=false; this.hitboxes=[]; this.els.gfx.innerHTML=''; this.els.phy.innerHTML=''; },
    toMenu() { this.reset(); this.els.menu.style.display='flex'; this.els.hud.style.display='none'; }
};

Game.init();
window.cmd = (c) => { if(c==='hitbox') document.getElementById('game').classList.toggle('debug'); };
</script>
</body>
</html>